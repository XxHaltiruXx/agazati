<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bejelentkez√©s folyamatban... - Agazati</title>
  <link rel="shortcut icon" href="assets/images/agazati.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0b091a;
      --bg-mid: #16162a;
      --text: #e4e4f0;
      --accent: #7f5af0;
      --accent-light: #9d7cf5;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .callback-container {
      text-align: center;
      max-width: 500px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto 2rem;
      border: 4px solid rgba(127, 90, 240, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: var(--accent-light);
    }

    p {
      color: var(--text);
      opacity: 0.8;
      line-height: 1.6;
    }

    .error-box {
      background: rgba(255, 77, 77, 0.1);
      border: 1px solid rgba(255, 77, 77, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
      display: none;
    }

    .error-box.show {
      display: block;
    }

    .error-box h2 {
      color: #ff4d4d;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .back-link {
      display: inline-block;
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .back-link:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="callback-container">
    <div class="spinner"></div>
    <h1 id="mainTitle">Bejelentkez√©s folyamatban...</h1>
    <p id="mainText">K√©rlek v√°rj, am√≠g feldolgozzuk az authentik√°ci√≥dat.</p>

    <!-- Password Reset Form -->
    <div id="passwordResetForm" style="display: none; max-width: 400px; margin: 0 auto;">
      <h1 style="margin-bottom: 1rem;">üîê √öj Jelsz√≥ Be√°ll√≠t√°sa</h1>
      <p style="margin-bottom: 1.5rem;">Add meg az √∫j jelszavadat:</p>
      
      <div style="margin-bottom: 1rem; text-align: left;">
        <label for="newPassword" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">√öj Jelsz√≥</label>
        <input 
          type="password" 
          id="newPassword" 
          placeholder="Minimum 6 karakter"
          style="width: 100%; padding: 0.75rem; background: var(--bg-mid); border: 1px solid var(--accent); border-radius: 6px; color: var(--text); font-size: 1rem;"
        >
      </div>
      
      <div style="margin-bottom: 1.5rem; text-align: left;">
        <label for="confirmPassword" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Jelsz√≥ Meger≈ës√≠t√©se</label>
        <input 
          type="password" 
          id="confirmPassword" 
          placeholder="Jelsz√≥ √∫jra"
          style="width: 100%; padding: 0.75rem; background: var(--bg-mid); border: 1px solid var(--accent); border-radius: 6px; color: var(--text); font-size: 1rem;"
        >
      </div>
      
      <button 
        id="resetPasswordBtn" 
        class="back-link" 
        style="width: 100%; cursor: pointer; border: none; font-size: 1rem;"
      >
        Jelsz√≥ Megv√°ltoztat√°sa
      </button>
      
      <div id="resetError" style="display: none; margin-top: 1rem; padding: 0.75rem; background: rgba(255, 77, 77, 0.1); border: 1px solid rgba(255, 77, 77, 0.3); border-radius: 6px; color: #ff4d4d;"></div>
      <div id="resetSuccess" style="display: none; margin-top: 1rem; padding: 0.75rem; background: rgba(77, 255, 77, 0.1); border: 1px solid rgba(77, 255, 77, 0.3); border-radius: 6px; color: #4dff4d;"></div>
    </div>

    <div class="error-box" id="errorBox">
      <h2>‚ùå Hiba t√∂rt√©nt</h2>
      <p id="errorMessage">Ismeretlen hiba</p>
      <a href="index.html" class="back-link">Vissza a f≈ëoldalra</a>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://ccpuoqrbmldunshaxpes.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjcHVvcXJibWxkdW5zaGF4cGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE2MDUsImV4cCI6MjA3ODA4NzYwNX0.QpVCmzF96Fp5hdgFyR0VkT9RV6qKiLkA8Yv_LArSk5I"

    // FONTOS: El≈ësz√∂r ellen≈ërizz√ºk a type param√©tert MIEL≈êTT inicializ√°ln√°nk a Supabase-t!
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const urlParams = new URLSearchParams(window.location.search);
    const authType = hashParams.get('type') || urlParams.get('type');
    
    console.log('üîç Auth type detected:', authType);
    console.log('Hash:', window.location.hash);
    console.log('Search:', window.location.search);
    
    // Session persistence be√°ll√≠t√°sa
    // Ha password recovery, akkor NE automatikusan dolgozza fel a session-t
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: authType !== 'recovery', // KI ha recovery!
        storage: window.localStorage
      }
    })

    console.log('‚úÖ Auth callback - Supabase client inicializ√°lva');

    async function handlePasswordReset() {
      console.log('üîê Password reset mode activated');
      
      // Manu√°lisan dolgozzuk fel a recovery token-t
      try {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        
        console.log('üîë Recovery tokens:', { 
          hasAccess: !!accessToken, 
          hasRefresh: !!refreshToken 
        });
        
        if (accessToken) {
          // Be√°ll√≠tjuk a session-t a recovery token-nel
          const { data, error } = await sb.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
          });
          
          if (error) {
            console.error('‚ùå Session setup error:', error);
            throw error;
          }
          
          console.log('‚úÖ Recovery session established');
        }
      } catch (err) {
        console.error('‚ùå Recovery token processing error:', err);
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        
        document.querySelector('.spinner').style.display = 'none';
        
        if (errorMessage) {
          errorMessage.textContent = 'A jelsz√≥ vissza√°ll√≠t√≥ link lej√°rt vagy √©rv√©nytelen. K√©rj √∫j linket!';
        }
        if (errorBox) {
          errorBox.classList.add('show');
        }
        return;
      }
      
      // Hide spinner and default text
      document.querySelector('.spinner').style.display = 'none';
      document.getElementById('mainTitle').style.display = 'none';
      document.getElementById('mainText').style.display = 'none';
      
      // Show password reset form
      document.getElementById('passwordResetForm').style.display = 'block';
      
      const resetBtn = document.getElementById('resetPasswordBtn');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const resetError = document.getElementById('resetError');
      const resetSuccess = document.getElementById('resetSuccess');
      
      resetBtn.addEventListener('click', async () => {
        resetError.style.display = 'none';
        resetSuccess.style.display = 'none';
        
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Valid√°ci√≥
        if (!newPassword || !confirmPassword) {
          resetError.textContent = '‚ùå K√©rlek t√∂ltsd ki mindk√©t mez≈ët!';
          resetError.style.display = 'block';
          return;
        }
        
        if (newPassword.length < 6) {
          resetError.textContent = '‚ùå A jelsz√≥nak legal√°bb 6 karakter hossz√∫nak kell lennie!';
          resetError.style.display = 'block';
          return;
        }
        
        if (newPassword !== confirmPassword) {
          resetError.textContent = '‚ùå A k√©t jelsz√≥ nem egyezik!';
          resetError.style.display = 'block';
          return;
        }
        
        try {
          resetBtn.disabled = true;
          resetBtn.textContent = 'Ment√©s...';
          
          console.log('üîÑ Updating password...');
          
          // Friss√≠tj√ºk a jelsz√≥t
          const { data, error } = await sb.auth.updateUser({
            password: newPassword
          });
          
          if (error) throw error;
          
          console.log('‚úÖ Password updated successfully');
          
          resetSuccess.textContent = '‚úÖ Jelsz√≥ sikeresen megv√°ltoztatva! √Åtir√°ny√≠t√°s...';
          resetSuccess.style.display = 'block';
          
          // √Åtir√°ny√≠t√°s a f≈ëoldalra
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          
        } catch (err) {
          console.error('‚ùå Password reset error:', err);
          resetError.textContent = `‚ùå Hiba: ${err.message || 'Ismeretlen hiba t√∂rt√©nt'}`;
          resetError.style.display = 'block';
          resetBtn.disabled = false;
          resetBtn.textContent = 'Jelsz√≥ Megv√°ltoztat√°sa';
        }
      });
      
      // Enter key support
      confirmPasswordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          resetBtn.click();
        }
      });
    }

    async function handleAuthCallback() {
      try {
        console.log('Auth callback started...');
        console.log('URL:', window.location.href);
        console.log('Hash:', window.location.hash);
        console.log('Search:', window.location.search);

        // Ellen≈ërizz√ºk hogy password reset-r≈ël van-e sz√≥
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const urlParams = new URLSearchParams(window.location.search);
        const type = hashParams.get('type') || urlParams.get('type');
        
        console.log('Auth type:', type);
        
        // Ha password recovery, akkor meg√°llunk itt √©s megh√≠vjuk a reset funkci√≥t
        if (type === 'recovery') {
          console.log('üîê Password recovery detected - showing password reset form');
          await handlePasswordReset();
          return; // FONTOS: ne menj√ºnk tov√°bb a norm√°l login flow-val!
        }

        // Ellen≈ërizz√ºk hogy van-e error param√©ter az URL-ben
        const errorParam = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        
        if (errorParam) {
          throw new Error(errorDescription || errorParam);
        }

        // Feldolgozza a hash-ben l√©v≈ë access token-t vagy a query param√©tereket
        const { data: sessionData, error: sessionError } = await sb.auth.getSession()
        
        console.log('Session data:', sessionData);
        
        if (sessionError) {
          console.error('Session error:', sessionError);
          throw sessionError
        }

        // Ellen≈ërizz√ºk a user-t
        const { data: userData, error: userError } = await sb.auth.getUser()
        
        console.log('User data:', userData);
        
        if (userError) {
          console.error('User error:', userError);
          throw userError;
        }
        
        if (!userData.user) {
          throw new Error("Nem siker√ºlt a felhaszn√°l√≥i adatok lek√©r√©se")
        }

        console.log("‚úÖ Sikeres bejelentkez√©s:", userData.user.email)

        // Email confirmation ellen≈ërz√©s
        if (!userData.user.email_confirmed_at) {
          console.warn('‚ö†Ô∏è Email m√©g nincs meger≈ës√≠tve');
        }

        // Visszat√©r√©si URL meghat√°roz√°sa - figyelembe vessz√ºk az /agazati/ mappa strukt√∫r√°t
        const getBaseUrl = () => {
          const origin = window.location.origin;
          const pathname = window.location.pathname;
          // Ha a pathname tartalmazza az '/agazati/' mapp√°t, akkor haszn√°ljuk azt
          if (pathname.includes('/agazati/')) {
            return origin + '/agazati/';
          }
          // K√ºl√∂nben csak az origin-t haszn√°ljuk
          return origin + '/';
        };
        
        const baseUrl = getBaseUrl();
        const returnUrl = urlParams.get('return_to') || localStorage.getItem('auth_return_url') || (baseUrl + 'index.html');
        
        console.log('Base URL:', baseUrl);
        console.log('Redirecting to:', returnUrl);
        
        // Clean up
        localStorage.removeItem('auth_return_url')

        // Redirect 1.5 m√°sodperc m√∫lva
        setTimeout(() => {
          window.location.href = returnUrl;
        }, 1500);

      } catch (err) {
        console.error("‚ùå Auth feldolgoz√°s hiba:", err)
        
        const errorBox = document.getElementById('errorBox')
        const errorMessage = document.getElementById('errorMessage')
        
        if (errorMessage) {
          errorMessage.textContent = err.message || "Hiba t√∂rt√©nt a bejelentkez√©s sor√°n. Pr√≥b√°ld √∫jra."
        }
        
        if (errorBox) {
          errorBox.classList.add('show')
        }

        // Hide spinner
        document.querySelector('.spinner').style.display = 'none'
        document.querySelector('h1').style.display = 'none'
        document.querySelector('p').style.display = 'none'
      }
    }

    // Ind√≠t√°s
    handleAuthCallback()
  </script>
</body>
</html>
