<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Admin Manager - Felhaszn√°l√≥k kezel√©se √©s admin jogosults√°gok" />
  <base href="../../" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <link rel="shortcut icon" href="assets/images/agazati.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/css/nav.css" />
  <link rel="stylesheet" href="assets/css/utilities.css" />
  <link rel="stylesheet" href="assets/css/footer.css" />
  <link rel="stylesheet" href="assets/css/infosharer.css" />
  <link rel="stylesheet" href="assets/css/auth-modal.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  
  <!-- Supabase Auth - KRITIKUS: el≈ëbb kell bet√∂lteni mint az admin-guard.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-auth.js"></script>
  
  <script src="assets/js/admin-guard.js"></script>
  
  <title>Admin Manager - Agazati</title>
</head>
<body data-page-auth="true">
  <div id="mySidenav" class="sidenav"></div>
  <h2 class="cim subsite">Admin Manager</h2>

  <!-- Bejelentkez√©s el≈ëtti n√©zet -->
  <div id="loginView">
    <div class="meta">
      Ez az oldal csak admin felhaszn√°l√≥k sz√°m√°ra √©rhet≈ë el.
      <br />Jelentkezz be az admin jogosults√°gok kezel√©s√©hez.
    </div>
    <div class="controls" style="justify-content: center; margin-top: 2rem;">
      <button id="loginBtn" class="secondary">Bejelentkez√©s</button>
    </div>
  </div>

  <!-- Admin n√©zet -->
  <div id="mainView" style="display: none;">
    <div class="meta">
      Admin felhaszn√°l√≥k kezel√©se √©s jogosults√°gok m√≥dos√≠t√°sa
      <br />
      <span style="color: var(--accent-light); font-weight: 500;">
        Bejelentkezve mint: <span id="currentUserEmail">-</span>
      </span>
    </div>

    <!-- Google Drive Admin Panel -->
    <div class="container" style="max-width: 1200px; margin-top: 2rem;">
      <div class="row mb-4">
        <div class="col-12">
          <div class="card" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(127, 90, 240, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <h3 style="color: var(--accent-light); margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
              <span>‚òÅÔ∏è</span> Google Drive Kezel√©s
            </h3>
            
            <!-- Els≈ë sor: Provider √©s st√°tusz -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
              <div>
                <div style="color: var(--muted); font-size: 0.875rem; margin-bottom: 0.5rem;">Storage Provider:</div>
                <div id="storageProvider" style="color: var(--text); font-weight: 600; font-size: 1.1rem;">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Bet√∂lt√©s...
                </div>
              </div>
              <div>
                <div style="color: var(--muted); font-size: 0.875rem; margin-bottom: 0.5rem;">Authentik√°ci√≥s St√°tusz:</div>
                <div id="driveAuthStatus" style="color: var(--muted); font-weight: 600; font-size: 1.1rem;">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Ellen≈ërz√©s...
                </div>
              </div>
            </div>

            <!-- M√°sodik sor: R√©szletes inform√°ci√≥k (csak ha be van jelentkezve) -->
            <div id="driveDetailsSection" style="display: none; background: rgba(127, 90, 240, 0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div>
                  <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem;">üìß Bejelentkezett fi√≥k:</div>
                  <div id="driveUserEmail" style="color: var(--accent-light); font-weight: 500; font-size: 0.95rem;">-</div>
                </div>
                <div>
                  <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                    üóÇÔ∏è Mappa ID:
                    <button id="editFolderIdBtn" class="ghost" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; display: none;">
                      ‚úèÔ∏è Szerkeszt√©s
                    </button>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div id="driveFolderId" style="color: var(--text); font-weight: 500; font-size: 0.95rem; font-family: monospace; flex: 1;">-</div>
                    <input type="text" id="folderIdInput" placeholder="Mappa ID..." style="display: none; flex: 1; padding: 0.4rem; border: 1px solid var(--accent); border-radius: 4px; background: var(--bg); color: var(--text); font-family: monospace;">
                    <button id="saveFolderIdBtn" class="secondary" style="display: none; padding: 0.4rem 0.8rem; font-size: 0.85rem;">üíæ Ment√©s</button>
                    <button id="cancelFolderIdBtn" class="ghost" style="display: none; padding: 0.4rem 0.8rem; font-size: 0.85rem;">‚ùå</button>
                  </div>
                </div>
                <div>
                  <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem;">üîë Client ID:</div>
                  <div id="driveClientId" style="color: var(--text); font-weight: 500; font-size: 0.85rem; font-family: monospace; word-break: break-all;">-</div>
                </div>
                <div>
                  <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem;">‚è∞ Bejelentkez√©s ideje:</div>
                  <div id="driveLoginTime" style="color: var(--text); font-weight: 500; font-size: 0.95rem;">-</div>
                </div>
                <div>
                  <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem;">üîê Token lej√°rat:</div>
                  <div id="driveTokenExpiry" style="color: var(--text); font-weight: 500; font-size: 0.95rem;">-</div>
                </div>
                <div>
                  <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem;">üìä Jogosults√°gok:</div>
                  <div id="driveScopes" style="color: var(--success); font-weight: 500; font-size: 0.85rem;">-</div>
                </div>
              </div>
            </div>

            <!-- Harmadik sor: Gombok -->
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: flex-start;">
              <button id="googleDriveAuthBtn" class="secondary" style="white-space: nowrap;">
                üîó Google Drive Bejelentkez√©s
              </button>
              <button id="googleDriveForceReauthBtn" class="secondary" style="white-space: nowrap; background: linear-gradient(135deg, #ff9800, #f57c00); display: none;">
                üîê √öjra-autentik√°ci√≥ (Force)
              </button>
              <button id="googleDriveLogoutBtn" class="ghost" style="white-space: nowrap; display: none; background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3);">
                üö™ Kijelentkez√©s
              </button>
              <button id="storageProviderToggle" class="ghost" style="white-space: nowrap;">
                üîÑ Provider v√°lt√°s
              </button>
              <button id="refreshDriveInfo" class="ghost" style="white-space: nowrap;">
                ‚ôªÔ∏è Friss√≠t√©s
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Google Drive F√°jlok List√°ja (Infosharer form√°tum) -->
    <div class="container" style="max-width: 1200px; margin-top: 2rem;">
      <div class="row mb-4">
        <div class="col-12">
          <div class="card" style="background: var(--surface); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h3 style="color: var(--text); margin: 0;">‚òÅÔ∏è Google Drive F√°jlok</h3>
                <p style="color: var(--muted); font-size: 0.9rem; margin: 0.5rem 0 0 0;">A megosztott mapp√°ban tal√°lhat√≥ f√°jlok</p>
              </div>
              <button id="refreshDriveFilesBtn" class="secondary">
                ‚ôªÔ∏è Friss√≠t√©s
              </button>
            </div>
            
            <!-- F√°jlok sz√°ml√°l√≥ -->
            <div id="driveFilesCount" style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Bet√∂lt√©s...
            </div>
            
            <!-- F√°jlok grid (ugyanaz mint az infoshareren) -->
            <div id="driveFilesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem;">
              <!-- Dinamikusan t√∂lt≈ëdik fel -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Felhaszn√°l√≥k lista -->
    <div class="container" style="max-width: 1200px; margin-top: 0;">
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 style="color: var(--text); margin: 0;">Regisztr√°lt Felhaszn√°l√≥k</h3>
            <button id="refreshBtn" class="ghost">Friss√≠t√©s</button>
          </div>
          
          <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border" role="status" style="color: var(--accent);">
              <span class="visually-hidden">Bet√∂lt√©s...</span>
            </div>
            <p class="mt-2" style="color: var(--muted);">Felhaszn√°l√≥k bet√∂lt√©se...</p>
          </div>

          <div id="usersTable" style="display: none;">
            <div class="table-responsive">
              <table class="table table-dark table-striped table-hover">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>D√°tumok</th>
                    <th>Admin</th>
                    <th>M≈±veletek</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Felhaszn√°l√≥k dinamikusan t√∂lt≈ëdnek be ide -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="noUsers" style="display: none;" class="alert alert-info">
            M√©g nincsenek regisztr√°lt felhaszn√°l√≥k.
          </div>

          <div id="errorMessage" style="display: none;" class="alert alert-danger">
            Hiba t√∂rt√©nt a felhaszn√°l√≥k bet√∂lt√©se k√∂zben.
          </div>
        </div>
      </div>
    </div>

    <!-- Kijelentkez√©s gomb -->
    <div class="controls" style="justify-content: center; margin-top: 2rem;">
      <button id="logoutBtn" class="ghost">Kijelentkez√©s</button>
    </div>
  </div>

  <!-- √öj Supabase Auth Modal bet√∂lt√©se -->
  <div id="authModalContainer"></div>

  <style>
    #loginView {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      text-align: center;
    }

    .table {
      color: var(--text);
      margin-top: 1rem;
    }

    .table thead th {
      border-color: rgba(127, 90, 240, 0.3);
      background: rgba(127, 90, 240, 0.1);
      font-weight: 600;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background: rgba(127, 90, 240, 0.15) !important;
    }

    .table tbody td {
      vertical-align: middle;
      border-color: rgba(127, 90, 240, 0.2);
    }

    .badge {
      padding: 0.4rem 0.8rem;
      font-weight: 500;
    }

    .admin-badge {
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      color: white;
    }

    .user-badge {
      background: rgba(255, 255, 255, 0.1);
      color: var(--muted);
    }

    .action-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      margin: 0 0.2rem;
    }

    @media (max-width: 768px) {
      .table {
        font-size: 0.85rem;
      }

      .action-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
      }
    }
  </style>

  <script>
    // ===================================
    // AUTH INICIALIZ√ÅL√ÅS - S√úRG≈êS!
    // ===================================
    // Ez a script ELS≈ê √©s azonnal inicializ√°lja az auth-ot
    // Az admin-guard.js-nek sz√ºks√©ge van r√°!
    (async function initAuthEarly() {
      // console.log('üöÄ Auth pre-init ind√≠t√°sa...');
      
      // V√°runk hogy a supabase-auth.js bet√∂lt≈ëdj√∂n (max 5 m√°sodperc)
      let attempts = 0;
      while (!window.initSupabaseAuth && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      // Auth inicializ√°l√°sa azonnal
      if (window.initSupabaseAuth && typeof window.initSupabaseAuth === 'function') {
        try {
          const auth = await window.initSupabaseAuth();
          window._agazati_auth_ready = true;
          // console.log('‚úÖ Auth pre-init sikeres');
        } catch (err) {
          console.error('‚ùå Auth pre-init hiba:', err);
        }
      } else {
        console.error('‚ùå initSupabaseAuth nem tal√°lhat√≥!');
      }
    })();
  </script>

  <script src="assets/js/nav.js"></script>
  <script src="assets/js/footer.js"></script>
  
  <!-- Google Drive Admin Panel kezel√©s -->
  <script type="module">
    import { signInWithOAuth2, getConfig, initializeGoogleDrive } from './assets/js/google-drive-api.js';
    import { getSupabaseClient } from './assets/js/supabase-client.js';
    
    // Supabase kliens (megosztott, sessionnel) - window objektumon hogy m√°s scriptek is haszn√°lhass√°k
    window.supabase = null;
    
    // Google Drive inicializ√°l√°s
    window.googleDriveInitialized = false;
    
    // V√°rjuk meg am√≠g az auth bet√∂lt √©s admin user vagyunk
    async function waitForAdminAuth(timeoutMs = 15000) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const auth = window.getAuth ? window.getAuth() : null;
        if (auth && auth.profileLoaded && auth.isAuthenticated() && auth.isAdminUser && auth.isAdminUser()) {
          return auth;
        }
        await new Promise(r => setTimeout(r, 200));
      }
      throw new Error('Auth nem t√∂lt≈ëd√∂tt be vagy nem admin user (timeout)');
    }
    
    async function initGoogleDrive(supabaseOverride = null) {
      if (window.googleDriveInitialized) return;
      try {
        await initializeGoogleDrive(supabaseOverride || window.supabase);
        window.googleDriveInitialized = true;
        console.log('‚úÖ Google Drive inicializ√°lva');
      } catch (error) {
        console.error('‚ùå Google Drive init hiba:', error);
      }
    }
    
    // Admin panel UI friss√≠t√©se r√©szletes inform√°ci√≥kkal
    async function updateAdminPanelUI() {
      const storageProviderSpan = document.getElementById('storageProvider');
      const driveAuthStatusSpan = document.getElementById('driveAuthStatus');
      const driveDetailsSection = document.getElementById('driveDetailsSection');
      const driveUserEmail = document.getElementById('driveUserEmail');
      const driveFolderId = document.getElementById('driveFolderId');
      const driveClientId = document.getElementById('driveClientId');
      const driveLoginTime = document.getElementById('driveLoginTime');
      const driveTokenExpiry = document.getElementById('driveTokenExpiry');
      const driveScopes = document.getElementById('driveScopes');
      const logoutBtn = document.getElementById('googleDriveLogoutBtn');
      
      // Storage provider megjelen√≠t√©se
      if (storageProviderSpan) {
        import('./assets/js/storage-adapter.js').then(module => {
          const provider = module.STORAGE_PROVIDER || 'supabase';
          const providerName = provider === 'googledrive' ? '‚òÅÔ∏è Google Drive' : 'üóÑÔ∏è Supabase';
          storageProviderSpan.innerHTML = `<span style="color: var(--accent-light);">${providerName}</span>`;
        }).catch(() => {
          storageProviderSpan.innerHTML = '<span style="color: var(--text);">üóÑÔ∏è Supabase</span> <span style="color: var(--muted); font-size: 0.85rem;">(alap√©rtelmezett)</span>';
        });
      }
      
      // Google Drive auth st√°tusz √©s r√©szletek
      if (driveAuthStatusSpan) {
        await initGoogleDrive();
        const config = getConfig();
        
        if (config && config.REFRESH_TOKEN) {
          // Bejelentkezve
          driveAuthStatusSpan.innerHTML = '<span style="color: #4caf50;">‚úÖ Akt√≠v</span>';
          
          // R√©szletes inform√°ci√≥k megjelen√≠t√©se
          if (driveDetailsSection) {
            driveDetailsSection.style.display = 'block';
            
            // Bejelentkezett fi√≥k (ha van userinfo)
            if (driveUserEmail) {
              try {
                // Google User Info lek√©r√©se (ha el√©rhet≈ë)
                const { getUserInfo } = await import('./assets/js/google-drive-api.js');
                const userInfo = await getUserInfo();
                
                const forceReauthBtn = document.getElementById('googleDriveForceReauthBtn');
                
                if (userInfo && userInfo.email) {
                  driveUserEmail.textContent = userInfo.email;
                  // Email OK - elrejtj√ºk a Force Re-auth gombot
                  if (forceReauthBtn) forceReauthBtn.style.display = 'none';
                } else {
                  // 401 vagy nincs email - FIGYELMEZTET√âS
                  driveUserEmail.innerHTML = '<span style="color: #ff9800; font-weight: 600;">‚ö†Ô∏è Nincs adat (401 Unauthorized)</span>';
                  // Megjelen√≠tj√ºk a Force Re-auth gombot
                  if (forceReauthBtn) forceReauthBtn.style.display = 'inline-block';
                  console.warn('‚ö†Ô∏è getUserInfo sikertelen - Force Re-auth sz√ºks√©ges!');
                }
              } catch (e) {
                driveUserEmail.innerHTML = '<span style="color: var(--error);">Email el√©rhetetlen</span>';
                // Hiba eset√©n is megjelen√≠tj√ºk a Force Re-auth gombot
                const forceReauthBtn = document.getElementById('googleDriveForceReauthBtn');
                if (forceReauthBtn) forceReauthBtn.style.display = 'inline-block';
              }
            }
            
            // Mappa ID + Szerkeszt√©s gomb megjelen√≠t√©se
            if (driveFolderId) {
              const editFolderIdBtn = document.getElementById('editFolderIdBtn');
              if (config.FOLDER_ID) {
                const folderId = config.FOLDER_ID;
                const shortId = folderId.length > 20 ? folderId.substring(0, 20) + '...' : folderId;
                driveFolderId.innerHTML = `<span title="${folderId}">${shortId}</span>`;
                // Szerkeszt√©s gomb megjelen√≠t√©se
                if (editFolderIdBtn) editFolderIdBtn.style.display = 'inline-block';
              } else {
                driveFolderId.innerHTML = '<span style="color: var(--error);">Nincs be√°ll√≠tva</span>';
                // Szerkeszt√©s gomb megjelen√≠t√©se m√©g ha nincs is be√°ll√≠tva
                if (editFolderIdBtn) editFolderIdBtn.style.display = 'inline-block';
              }
            }
            
            // Client ID
            if (driveClientId) {
              if (config.CLIENT_ID) {
                const clientId = config.CLIENT_ID;
                const shortClientId = clientId.length > 30 ? clientId.substring(0, 30) + '...' : clientId;
                driveClientId.innerHTML = `<span title="${clientId}">${shortClientId}</span>`;
              } else {
                driveClientId.innerHTML = '<span style="color: var(--error);">Hi√°nyzik</span>';
              }
            }
            
            // Bejelentkez√©s ideje (a refresh token l√©trehoz√°sakor)
            if (driveLoginTime) {
              try {
                // Lek√©rj√ºk az app_config-b√≥l a timestamp-et
                const { data, error } = await supabase
                  .from('app_config')
                  .select('updated_at')
                  .eq('key', 'google_drive_refresh_token')
                  .maybeSingle();
                
                if (error) {
                  console.warn('‚ö†Ô∏è Timestamp lek√©r√©si hiba:', error);
                  driveLoginTime.innerHTML = '<span style="color: var(--muted);">Lek√©r√©s sikertelen</span>';
                } else if (data && data.updated_at) {
                  const loginDate = new Date(data.updated_at);
                  driveLoginTime.textContent = loginDate.toLocaleString('hu-HU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  });
                } else {
                  driveLoginTime.innerHTML = '<span style="color: var(--muted);">Ismeretlen</span>';
                }
              } catch (e) {
                console.error('‚ùå Timestamp lek√©r√©si hiba:', e);
                driveLoginTime.innerHTML = '<span style="color: var(--muted);">Lek√©r√©s sikertelen</span>';
              }
            }
            
            // Token lej√°rat
            if (driveTokenExpiry) {
              driveTokenExpiry.innerHTML = '<span style="color: var(--success);">‚ôæÔ∏è Automatikus friss√≠t√©s</span>';
            }
            
            // Jogosults√°gok
            if (driveScopes) {
              const scopes = config.SCOPES || ['https://www.googleapis.com/auth/drive.readonly', 'https://www.googleapis.com/auth/userinfo.email'];
              const scopeNames = scopes.map(s => {
                if (s.includes('drive.file')) return 'F√°jlkezel√©s (csak app f√°jlok)';
                if (s.includes('drive.readonly')) return 'Drive olvas√°s (√∂sszes f√°jl)';
                if (s.includes('drive') && !s.includes('file') && !s.includes('readonly')) return 'Drive teljes hozz√°f√©r√©s';
                if (s.includes('userinfo.email')) return 'Email hozz√°f√©r√©s';
                return s.split('/').pop();
              }).join(', ');
              driveScopes.textContent = scopeNames;
            }
            
            // Kijelentkez√©s gomb megjelen√≠t√©se
            if (logoutBtn) {
              logoutBtn.style.display = 'inline-block';
            }
          }
        } else if (!config) {
          // Nincs konfigur√°ci√≥
          driveAuthStatusSpan.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è Nincs konfigur√°ci√≥</span>';
          if (driveDetailsSection) driveDetailsSection.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'none';
        } else {
          // Nincs refresh token
          driveAuthStatusSpan.innerHTML = '<span style="color: #f44336;">‚ùå Nincs bejelentkezve</span>';
          if (driveDetailsSection) driveDetailsSection.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'none';
        }
      }
    }
    
    // Google Drive Auth gomb kezel√©se
    document.addEventListener('DOMContentLoaded', async () => {
      const authBtn = document.getElementById('googleDriveAuthBtn');
      const toggleBtn = document.getElementById('storageProviderToggle');
      
      // Supabase kliens (sessionnel)
      window.supabase = await getSupabaseClient();

      // V√°rjuk meg hogy az auth bet√∂lt≈ëdj√∂n √©s admin legy√©l
      let adminAuth = null;
      try {
        adminAuth = await waitForAdminAuth();
      } catch (e) {
        console.error('Auth init hiba:', e);
        alert('‚ùå Az admin authentik√°ci√≥ nem el√©rhet≈ë. Jelentkezz be el≈ëbb.');
        return;
      }

      // Google Drive inicializ√°l√°s (imm√°r admin sessionnel)
      await initGoogleDrive(adminAuth ? adminAuth.sb : supabase);
      
      // Kezdeti UI friss√≠t√©s
      await updateAdminPanelUI();
      
      // Google Drive bejelentkez√©s gomb
      if (authBtn) {
        authBtn.addEventListener('click', async () => {
          try {
            authBtn.disabled = true;
            authBtn.textContent = '‚è≥ Bejelentkez√©s...';
            
            // Ellen≈ërizz√ºk hogy van-e konfigur√°ci√≥
            const config = getConfig();
            if (!config) {
              throw new Error('‚ö†Ô∏è Google Drive konfigur√°ci√≥ hi√°nyzik!\n\n1. Futtasd le: database/google-drive-config-table.sql\n2. Google Cloud Console: Hozz l√©tre OAuth Client ID-t\n3. UPDATE app_config a CLIENT_ID √©s CLIENT_SECRET √©rt√©kekkel');
            }
            
            // FORCE CONSENT - mindig k√©rje √∫jra a jogosults√°gokat az √∫j scope-okkal
            await signInWithOAuth2(true); // Force consent bejelentkez√©s!
            
            // Sikeres bejelentkez√©s
            authBtn.textContent = '‚úÖ Sikeres bejelentkez√©s!';
            authBtn.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
            
            // UI friss√≠t√©se
            setTimeout(async () => {
              await updateAdminPanelUI();
              authBtn.textContent = 'üîó Google Drive Bejelentkez√©s';
              authBtn.style.background = '';
              authBtn.disabled = false;
            }, 2000);
            
          } catch (error) {
            console.error('‚ùå Google Drive bejelentkez√©si hiba:', error);
            alert('‚ùå Bejelentkez√©si hiba:\n\n' + error.message);
            authBtn.textContent = 'üîó Google Drive Bejelentkez√©s';
            authBtn.disabled = false;
          }
        });
      }
      
      // Google Drive FORCE RE-AUTH gomb (√∫j scope-okhoz)
      const forceReauthBtn = document.getElementById('googleDriveForceReauthBtn');
      if (forceReauthBtn) {
        forceReauthBtn.addEventListener('click', async () => {
          if (!confirm('üîê FORCE RE-AUTHENTICATION\n\nEz a gomb t√∂rli a r√©gi refresh token-t √©s MINDIG √∫jra k√©ri az √ñSSZES OAuth jogosults√°got.\n\nHaszn√°ld ezt, ha:\n- √öj scope-ot adt√°l hozz√° a k√≥dhoz\n- 401 Unauthorized hib√°t kapsz\n- Az email c√≠m nem jelenik meg\n\nFolytassuk?')) {
            return;
          }
          
          try {
            forceReauthBtn.disabled = true;
            forceReauthBtn.textContent = '‚è≥ Token t√∂rl√©se...';
            
            // 1. Token t√∂rl√©se - ADMIN SESSION haszn√°lata
            console.log('üóëÔ∏è R√©gi refresh token t√∂rl√©se (admin session)...');
            
            // Admin auth session haszn√°lata (ami m√°r be van jelentkezve)
            const adminAuth = window.getAuth ? window.getAuth() : null;
            const supabaseToUse = adminAuth && adminAuth.sb ? adminAuth.sb : window.supabase;
            
            // Els≈ë pr√≥b√°lkoz√°s: RPC function (ha l√©tezik)
            let tokenDeleted = false;
            try {
              const { error: rpcError } = await supabaseToUse.rpc('delete_google_drive_token');
              if (!rpcError) {
                console.log('‚úì Token t√∂r√∂lve RPC-vel');
                tokenDeleted = true;
              } else {
                console.warn('‚ö†Ô∏è RPC hiba:', rpcError.message);
              }
            } catch (rpcErr) {
              console.warn('‚ö†Ô∏è RPC nem el√©rhet≈ë:', rpcErr.message);
            }
            
            // M√°sodik pr√≥b√°lkoz√°s: Direkt DELETE (fallback)
            if (!tokenDeleted) {
              const { error: deleteError } = await supabaseToUse
                .from('app_config')
                .delete()
                .eq('key', 'google_drive_refresh_token');
              
              if (deleteError) {
                console.error('‚ùå Token t√∂rl√©si hiba:', deleteError);
                throw new Error(`Token t√∂rl√©si hiba: ${deleteError.message}`);
              } else {
                console.log('‚úì Token t√∂r√∂lve direkt DELETE-tel');
                tokenDeleted = true;
              }
            }
            
            if (!tokenDeleted) {
              throw new Error('Token t√∂rl√©se sikertelen (nincs enged√©ly vagy RLS blokkolja)');
            }
            
            forceReauthBtn.textContent = 'üîê √öjra-autentik√°ci√≥...';
            await new Promise(r => setTimeout(r, 500)); // Kis sz√ºnet
            
            // 2. Force consent bejelentkez√©s
            await signInWithOAuth2(true); // FORCE CONSENT!
            
            // Sikeres bejelentkez√©s
            forceReauthBtn.textContent = '‚úÖ Sikeres!';
            forceReauthBtn.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
            
            // UI friss√≠t√©se
            setTimeout(async () => {
              await updateAdminPanelUI();
              forceReauthBtn.textContent = 'üîê √öjra-autentik√°ci√≥ (Force)';
              forceReauthBtn.style.background = '';
              forceReauthBtn.disabled = false;
            }, 2000);
            
          } catch (error) {
            console.error('‚ùå Force Re-auth hiba:', error);
            forceReauthBtn.textContent = '‚ùå Hiba t√∂rt√©nt';
            forceReauthBtn.style.background = 'linear-gradient(135deg, #f44336, #e53935)';
            
            // R√©szletes hiba√ºzenet
            let errorMsg = '‚ùå Force Re-authentication hiba:\n\n';
            if (error.message.includes('Token t√∂rl√©si hiba')) {
              errorMsg += 'A token t√∂rl√©se sikertelen!\n\n';
              errorMsg += 'MEGOLD√ÅS:\n';
              errorMsg += '1. Menj a Supabase Dashboard-ra\n';
              errorMsg += '2. SQL Editor ‚Üí New Query\n';
              errorMsg += '3. Futtasd le:\n\n';
              errorMsg += "DELETE FROM app_config WHERE key = 'google_drive_refresh_token';\n\n";
              errorMsg += '4. Pr√≥b√°ld √∫jra a Force Re-auth gombot';
            } else {
              errorMsg += error.message;
            }
            
            alert(errorMsg);
            
            setTimeout(() => {
              forceReauthBtn.textContent = 'ÔøΩ √öjra-autentik√°ci√≥ (Force)';
              forceReauthBtn.style.background = '';
              forceReauthBtn.disabled = false;
            }, 2000);
          }
        });
      }
      
      // Google Drive kijelentkez√©s gomb
      const logoutBtn = document.getElementById('googleDriveLogoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          if (!confirm('üö™ Biztosan ki szeretn√©l jelentkezni a Google Drive-b√≥l?\n\nA refresh token t√∂rl√©sre ker√ºl az adatb√°zisb√≥l.')) {
            return;
          }
          
          try {
            logoutBtn.disabled = true;
            logoutBtn.textContent = '‚è≥ Kijelentkez√©s...';
            
            console.log('ÔøΩÔ∏è Refresh token t√∂rl√©se (admin session)...');
            
            // Admin auth session haszn√°lata (ami m√°r be van jelentkezve)
            const adminAuth = window.getAuth ? window.getAuth() : null;
            const supabaseToUse = adminAuth && adminAuth.sb ? adminAuth.sb : window.supabase;
            
            // Els≈ë pr√≥b√°lkoz√°s: RPC function (ha l√©tezik)
            let tokenDeleted = false;
            try {
              const { error: rpcError } = await supabaseToUse.rpc('delete_google_drive_token');
              if (!rpcError) {
                console.log('‚úì Token t√∂r√∂lve RPC-vel');
                tokenDeleted = true;
              } else {
                console.warn('‚ö†Ô∏è RPC hiba:', rpcError.message);
              }
            } catch (rpcErr) {
              console.warn('‚ö†Ô∏è RPC nem el√©rhet≈ë:', rpcErr.message);
            }
            
            // M√°sodik pr√≥b√°lkoz√°s: Direkt DELETE (fallback)
            if (!tokenDeleted) {
              const { error: deleteError } = await supabaseToUse
                .from('app_config')
                .delete()
                .eq('key', 'google_drive_refresh_token');
              
              if (deleteError) {
                console.error('‚ùå Token t√∂rl√©si hiba:', deleteError);
                throw new Error(`Token t√∂rl√©si hiba: ${deleteError.message}`);
              } else {
                console.log('‚úì Token t√∂r√∂lve direkt DELETE-tel');
                tokenDeleted = true;
              }
            }
            
            if (!tokenDeleted) {
              throw new Error('Token t√∂rl√©se sikertelen (nincs enged√©ly vagy RLS blokkolja)');
            }
            
            console.log('‚úì Token sikeresen t√∂r√∂lve');
            
            logoutBtn.textContent = '‚úÖ Kijelentkezve!';
            logoutBtn.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
            
            // UI friss√≠t√©se
            setTimeout(async () => {
              await updateAdminPanelUI();
              logoutBtn.textContent = 'üö™ Kijelentkez√©s';
              logoutBtn.style.background = '';
              logoutBtn.disabled = false;
              
              // Oldal √∫jrat√∂lt√©se hogy a v√°ltoz√°sok √©letbe l√©pjenek
              location.reload();
            }, 1500);
            
          } catch (error) {
            console.error('‚ùå Kijelentkez√©si hiba:', error);
            
            // R√©szletes hiba√ºzenet
            let errorMsg = '‚ùå Kijelentkez√©si hiba:\n\n';
            if (error.message.includes('Token t√∂rl√©si hiba')) {
              errorMsg += 'A token t√∂rl√©se sikertelen!\n\n';
              errorMsg += 'MEGOLD√ÅS:\n';
              errorMsg += '1. Menj a Supabase Dashboard-ra\n';
              errorMsg += '2. SQL Editor ‚Üí New Query\n';
              errorMsg += '3. Futtasd le:\n\n';
              errorMsg += "DELETE FROM app_config WHERE key = 'google_drive_refresh_token';\n\n";
              errorMsg += '4. T√∂ltsd √∫jra az oldalt';
            } else {
              errorMsg += error.message;
            }
            
            alert(errorMsg);
            logoutBtn.textContent = 'üö™ Kijelentkez√©s';
            logoutBtn.style.background = '';
            logoutBtn.disabled = false;
          }
        });
      }
      
      // Friss√≠t√©s gomb
      const refreshBtn = document.getElementById('refreshDriveInfo');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          refreshBtn.disabled = true;
          refreshBtn.textContent = '‚è≥ Friss√≠t√©s...';
          
          try {
            await updateAdminPanelUI();
            refreshBtn.textContent = '‚úÖ Friss√≠tve!';
            
            setTimeout(() => {
              refreshBtn.textContent = '‚ôªÔ∏è Friss√≠t√©s';
              refreshBtn.disabled = false;
            }, 1000);
          } catch (error) {
            console.error('Friss√≠t√©si hiba:', error);
            refreshBtn.textContent = '‚ôªÔ∏è Friss√≠t√©s';
            refreshBtn.disabled = false;
          }
        });
      }
      
      // Mappa ID szerkeszt√©s gombok
      const editFolderIdBtn = document.getElementById('editFolderIdBtn');
      const saveFolderIdBtn = document.getElementById('saveFolderIdBtn');
      const cancelFolderIdBtn = document.getElementById('cancelFolderIdBtn');
      const folderIdInput = document.getElementById('folderIdInput');
      const driveFolderIdDisplay = document.getElementById('driveFolderId');
      
      if (editFolderIdBtn && saveFolderIdBtn && cancelFolderIdBtn && folderIdInput) {
        // Szerkeszt√©s gomb
        editFolderIdBtn.addEventListener('click', () => {
          const currentFolderId = driveFolderIdDisplay.querySelector('span')?.title || '';
          folderIdInput.value = currentFolderId;
          
          // UI v√°lt√°s
          driveFolderIdDisplay.style.display = 'none';
          editFolderIdBtn.style.display = 'none';
          folderIdInput.style.display = 'block';
          saveFolderIdBtn.style.display = 'inline-block';
          cancelFolderIdBtn.style.display = 'inline-block';
          folderIdInput.focus();
        });
        
        // Ment√©s gomb
        saveFolderIdBtn.addEventListener('click', async () => {
          const newFolderId = folderIdInput.value.trim();
          
          if (!newFolderId) {
            alert('‚ùå A Mappa ID nem lehet √ºres!');
            return;
          }
          
          try {
            saveFolderIdBtn.disabled = true;
            saveFolderIdBtn.textContent = '‚è≥ Ment√©s...';
            
            // Bet√∂ltj√ºk a jelenlegi konfigur√°ci√≥t
            const config = getConfig();
            
            // Friss√≠tj√ºk a FOLDER_ID-t
            config.FOLDER_ID = newFolderId;
            
            // Mentj√ºk a teljes konfigur√°ci√≥t
            const { saveGoogleDriveConfig } = await import('./assets/js/google-drive-config-manager.js');
            await saveGoogleDriveConfig(window.supabase, config);
            
            console.log('‚úì Mappa ID mentve:', newFolderId);
            
            saveFolderIdBtn.textContent = '‚úÖ Mentve!';
            
            // UI vissza√°ll√≠t√°s √©s friss√≠t√©s
            setTimeout(async () => {
              driveFolderIdDisplay.style.display = 'flex';
              editFolderIdBtn.style.display = 'inline-block';
              folderIdInput.style.display = 'none';
              saveFolderIdBtn.style.display = 'none';
              cancelFolderIdBtn.style.display = 'none';
              saveFolderIdBtn.textContent = 'üíæ Ment√©s';
              saveFolderIdBtn.disabled = false;
              
              // Konfigur√°ci√≥ √∫jrat√∂lt√©se √©s UI friss√≠t√©s
              await updateAdminPanelUI();
            }, 1000);
            
          } catch (error) {
            console.error('‚ùå Mappa ID ment√©si hiba:', error);
            alert('‚ùå Mappa ID ment√©si hiba:\n\n' + error.message);
            saveFolderIdBtn.textContent = 'üíæ Ment√©s';
            saveFolderIdBtn.disabled = false;
          }
        });
        
        // M√©gse gomb
        cancelFolderIdBtn.addEventListener('click', () => {
          driveFolderIdDisplay.style.display = 'flex';
          editFolderIdBtn.style.display = 'inline-block';
          folderIdInput.style.display = 'none';
          saveFolderIdBtn.style.display = 'none';
          cancelFolderIdBtn.style.display = 'none';
        });
      }
      
      // Storage provider toggle gomb
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          alert('‚ö†Ô∏è Provider v√°lt√°s:\n\nA storage provider v√°lt√°s√°hoz m√≥dos√≠tsd a\nassets/js/storage-adapter.js f√°jlban a STORAGE_PROVIDER konstanst:\n\n"supabase" vagy "googledrive"\n\nEzut√°n t√∂ltsd √∫jra az oldalt.');
        });
      }
    });
  </script>
  
  <script>
    // ===================================
    // ADMIN MANAGER
    // ===================================
    let auth;
    let authModal;
    let sb;

    // DOM elemek
    const loginView = document.getElementById('loginView');
    const mainView = document.getElementById('mainView');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserEmail = document.getElementById('currentUserEmail');
    const refreshBtn = document.getElementById('refreshBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const usersTable = document.getElementById('usersTable');
    const usersTableBody = document.getElementById('usersTableBody');
    const noUsers = document.getElementById('noUsers');
    const errorMessage = document.getElementById('errorMessage');

    // ===================================
    // INICIALIZ√ÅL√ÅS
    // ===================================
    document.addEventListener('DOMContentLoaded', async function() {
      // V√°runk az auth inicializ√°l√°s√°ra (max 10 m√°sodperc)
      // console.log('‚è≥ V√°rakoz√°s az auth inicializ√°l√°s√°ra...');
      let attempts = 0;
      while ((!window.getAuth || !window._agazati_auth_ready) && attempts < 100) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
        if (attempts % 10 === 0) {
          // console.log(`‚è≥ V√°rakoz√°s... ${attempts/10}s (getAuth: ${!!window.getAuth}, ready: ${!!window._agazati_auth_ready})`);
        }
      }
      
      // Supabase Auth megszerz√©se
      if (window.getAuth) {
        auth = window.getAuth();
        // console.log('‚úÖ Auth megszerezve');
      } else {
        console.error('‚ùå Auth nem tal√°lhat√≥! window.getAuth nem el√©rhet≈ë.');
        alert('‚ùå Hiba t√∂rt√©nt az authentik√°ci√≥ bet√∂lt√©sekor.\n\nFriss√≠tsd az oldalt (F5)!');
        return;
      }
      
      // console.log('‚úÖ Auth ready:', auth.isAuthenticated() ? 'Bejelentkezve' : 'Nincs bejelentkezve');
      // console.log('üîë Admin status:', auth.isAdminUser());
      
      sb = auth.sb;

      // Auth Modal HTML bet√∂lt√©se - csak ha m√©g nincs
      let authModalContainer = document.getElementById('authModalContainer');
      if (!authModalContainer) {
        authModalContainer = document.createElement('div');
        authModalContainer.id = 'authModalContainer';
        document.body.appendChild(authModalContainer);
      }
      
      if (!authModalContainer.innerHTML.trim()) {
        const response = await fetch('assets/components/auth-modal.html');
        const html = await response.text();
        authModalContainer.innerHTML = html;
      }

      // Auth Modal inicializ√°l√°s
      authModal = new window.SupabaseAuthModal(auth);
      authModal.init({
        onSuccess: async () => {
          // V√°runk egy kicsit hogy a user_roles bet√∂lt≈ëdj√∂n
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Friss√≠tj√ºk a user profilt
          if (auth.currentUser) {
            await auth.loadUserProfile(auth.currentUser);
          }
          
          if (auth.isAdminUser()) {
            // console.log('‚úÖ Admin felhaszn√°l√≥, f≈ën√©zet megjelen√≠t√©se');
            await showMainView();
          } else {
            alert('‚ùå Nincs jogosults√°god az admin oldalakhoz! Csak admin felhaszn√°l√≥k √©rhetik el ezt az oldalt.');
            showLoginView();
          }
        },
        onCancel: () => {
          // Marad a login view
        }
      });

      // Login button click
      loginBtn?.addEventListener('click', () => {
        authModal.open();
      });

      // Logout button
      logoutBtn?.addEventListener('click', async () => {
        await auth.signOut();
        showLoginView();
        location.reload();
      });

      // Refresh button
      refreshBtn?.addEventListener('click', () => {
        loadUsers();
      });

      // Auto-login ellen≈ërz√©s
      if (auth.isAuthenticated()) {
        // console.log('Bejelentkezett felhaszn√°l√≥, admin jog ellen≈ërz√©se...');
        if (auth.isAdminUser()) {
          // console.log('‚úÖ Admin jogosults√°g van, f≈ën√©zet megjelen√≠t√©se');
          await showMainView();
        } else {
          // console.log('‚ùå Nincs admin jogosults√°g');
          alert('‚ùå Nincs jogosults√°god az admin oldalakhoz!');
          await auth.signOut();
          showLoginView();
        }
      } else {
        // console.log('Nincs bejelentkezve, login n√©zet megjelen√≠t√©se');
        showLoginView();
      }
    });

    // ===================================
    // VIEW KEZEL√âS
    // ===================================
    function showLoginView() {
      if (loginView) loginView.style.display = 'flex';
      if (mainView) mainView.style.display = 'none';
    }

    async function showMainView() {
      if (loginView) loginView.style.display = 'none';
      if (mainView) mainView.style.display = 'block';
      
      if (currentUserEmail) {
        currentUserEmail.textContent = auth.getUserEmail() || '-';
      }
      
      await loadUsers();
    }

    // ===================================
    // FELHASZN√ÅL√ìK BET√ñLT√âSE
    // ===================================
    async function loadUsers() {
      // console.log('üîÑ loadUsers() h√≠v√°s...');
      loadingSpinner.style.display = 'block';
      usersTable.style.display = 'none';
      noUsers.style.display = 'none';
      errorMessage.style.display = 'none';

      try {
        // El≈ësz√∂r lek√©rj√ºk a user_roles t√°bl√°t
        const { data: userRoles, error: rolesError } = await sb
          .from('user_roles')
          .select('*')
          .order('created_at', { ascending: false });

        if (rolesError) throw rolesError;
        
        // console.log(`‚úÖ ${userRoles.length} felhaszn√°l√≥ bet√∂ltve`);

        // Megpr√≥b√°ljuk lek√©rni a profiles t√°bl√°t (ha l√©tezik)
        let profilesMap = new Map();
        try {
          const { data: profilesData } = await sb
            .from('profiles')
            .select('id, email');
          
          if (profilesData) {
            profilesData.forEach(p => profilesMap.set(p.id, p.email));
            // console.log('‚úÖ Profiles t√°bla bet√∂ltve:', profilesData.length, 'profil');
          }
        } catch (e) {
          // console.warn('‚ö†Ô∏è Profiles t√°bla nem l√©tezik - futtasd le a supabase-create-profiles-table.sql scriptet!');
        }

        // Felhaszn√°l√≥i adatok √∂ssze√°ll√≠t√°sa
        const currentUser = auth.currentUser;
        const usersWithDetails = userRoles.map(userRole => {
          let email = 'Ismeretlen';
          
          // 1. Pr√≥b√°ljuk a profiles t√°bl√°b√≥l
          if (profilesMap.has(userRole.user_id)) {
            email = profilesMap.get(userRole.user_id);
          }
          // 2. Ha ez az aktu√°lis user, haszn√°ljuk a session emailt
          else if (currentUser && currentUser.id === userRole.user_id) {
            email = currentUser.email || 'Ismeretlen';
          }
          // 3. Egy√©bk√©nt partial user ID
          else {
            email = `User ${userRole.user_id.substring(0, 8)}...`;
          }
          
          return {
            ...userRole,
            email: email
          };
        });

        loadingSpinner.style.display = 'none';

        if (usersWithDetails.length === 0) {
          noUsers.style.display = 'block';
          return;
        }

        // T√°bl√°zat felt√∂lt√©se
        usersTableBody.innerHTML = '';
        usersWithDetails.forEach(user => {
          const row = createUserRow(user);
          usersTableBody.appendChild(row);
        });

        usersTable.style.display = 'block';

      } catch (error) {
        console.error('Hiba a felhaszn√°l√≥k bet√∂lt√©sekor:', error);
        loadingSpinner.style.display = 'none';
        errorMessage.style.display = 'block';
        errorMessage.textContent = `Hiba: ${error.message}`;
      }
    }
    
    // Glob√°lis hozz√°f√©r√©s a real-time friss√≠t√©shez
    window.loadUsers = loadUsers;

    // ===================================
    // FELHASZN√ÅL√ì SOR L√âTREHOZ√ÅSA
    // ===================================
    function createUserRow(user) {
      const tr = document.createElement('tr');
      
      const isCurrentUser = user.user_id === auth.getUserId();
      
      tr.innerHTML = `
        <td>
          ${user.email}
          ${isCurrentUser ? '<span class="badge bg-info ms-2">Te</span>' : ''}
        </td>
        <td>
          <small class="text-muted">Regisztr√°ci√≥:</small><br>
          ${formatDate(user.created_at)}
          ${user.updated_at && user.updated_at !== user.created_at ? 
            `<br><small class="text-muted">M√≥dos√≠tva:</small><br>${formatDate(user.updated_at)}` : 
            ''}
        </td>
        <td>
          <span class="badge ${user.is_admin ? 'admin-badge' : 'user-badge'}">
            ${user.is_admin ? 'Admin' : 'User'}
          </span>
        </td>
        <td>
          ${isCurrentUser ? 
            '<span class="text-muted">-</span>' : 
            `<button class="btn btn-sm ${user.is_admin ? 'btn-warning' : 'btn-success'} action-btn" 
              onclick="toggleAdmin.call(this, '${user.user_id}', ${!user.is_admin})">
              ${user.is_admin ? 'Admin elt√°vol√≠t√°sa' : 'Admin hozz√°ad√°sa'}
            </button>`
          }
        </td>
      `;
      
      return tr;
    }

    // ===================================
    // ADMIN TOGGLING
    // ===================================
    async function toggleAdmin(userId, makeAdmin) {
      // BIZTONS√ÅGI CHECK: Ellen≈ërizz√ºk hogy m√©g admin vagyunk-e
      if (!auth || !auth.isAuthenticated() || !auth.isAdminUser()) {
        alert('‚õî Hiba: M√°r nem vagy admin!\n\nVisszair√°ny√≠tunk a f≈ëoldalra.');
        const baseUrl = window.location.pathname.includes('/agazati/') ? '/agazati/' : '/';
        window.location.href = baseUrl;
        return;
      }
      
      const action = makeAdmin ? 'hozz√°ad√°sa' : 'elt√°vol√≠t√°sa';
      
      if (!confirm(`Biztos vagy benne, hogy ${makeAdmin ? 'admin jogot adsz' : 'elveszed az admin jogot'} ett≈ël a felhaszn√°l√≥t√≥l?`)) {
        return;
      }

      // Loading state - gomb letilt√°sa (this context a gomb)
      const clickedButton = this;
      const originalText = clickedButton?.textContent || '';
      if (clickedButton && clickedButton.tagName === 'BUTTON') {
        clickedButton.disabled = true;
        clickedButton.textContent = '‚è≥ Feldolgoz√°s...';
      }

      try {
        // console.log(`üîÑ Admin jog ${makeAdmin ? 'hozz√°ad√°sa' : 'elt√°vol√≠t√°sa'}: ${userId}`);
        
        // M≈±velet v√©grehajt√°sa - V√ÅRAKOZ√ÅS az eredm√©nyre!
        const result = await auth.setUserAdmin(userId, makeAdmin);
        
        // console.log('‚úÖ Admin jog sikeresen m√≥dos√≠tva:', result);
        
        // V√°runk m√©g 300ms-ot hogy biztos propag√°l√≥djon a v√°ltoz√°s
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Sikeres visszajelz√©s
        alert(`‚úÖ Sikeresen ${makeAdmin ? 'hozz√°adtad az admin jogot' : 'elvetted az admin jogot'}!\n\nüì¢ A felhaszn√°l√≥ automatikusan √©rtes√≠t√©st kap a v√°ltoz√°sr√≥l.`);
        
        // Friss√≠ts√ºk a list√°t - √öJRA lek√©rdezz√ºk az adatb√°zist
        // console.log('üîÑ Felhaszn√°l√≥k lista friss√≠t√©se...');
        await loadUsers();
        // console.log('‚úÖ Lista friss√≠tve');
        
      } catch (error) {
        console.error('‚ùå Hiba az admin jog m√≥dos√≠t√°sakor:', error);
        
        // R√©szletesebb hiba√ºzenet
        let errorMsg = error.message || 'Ismeretlen hiba';
        
        if (errorMsg.includes('function public.set_user_admin_metadata does not exist')) {
          errorMsg = '‚ö†Ô∏è Database funkci√≥ hi√°nyzik!\n\nFuttasd le a set-admin-metadata-function.sql scriptet a Supabase Dashboard-on (SQL Editor).';
        }
        
        alert(`‚ùå Hiba t√∂rt√©nt:\n\n${errorMsg}`);
      } finally {
        // Gomb √∫jra enged√©lyez√©se
        if (clickedButton && clickedButton.tagName === 'BUTTON') {
          clickedButton.disabled = false;
          clickedButton.textContent = originalText;
        }
      }
    }

    // ===================================
    // SEG√âDF√úGGV√âNYEK
    // ===================================
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('hu-HU', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ===================================
    // FOLYAMATOS ADMIN ST√ÅTUSZ ELLEN≈êRZ√âS
    // ===================================
    function getBaseUrl() {
      const origin = window.location.origin;
      const pathname = window.location.pathname;
      if (origin.includes('github.io') || pathname.includes('/agazati/')) {
        return origin.includes('github.io') ? origin + '/agazati/' : '/agazati/';
      }
      return '/';
    }
    
    function setupContinuousAdminCheck() {
      // console.log('üîí Folyamatos admin ellen≈ërz√©s be√°ll√≠t√°sa...');
      
      // Figyelj√ºk a login state v√°ltoz√°sokat
      window.addEventListener('loginStateChanged', (event) => {
        // console.log('üì° loginStateChanged event:', event.detail);
        const { loggedIn, isAdmin } = event.detail;
        
        // Ha elvesztett√ºk az admin jogot
        if (loggedIn && !isAdmin) {
          // console.warn('‚õî Admin jog elvesz√≠tve - √°tir√°ny√≠t√°s...');
          alert('‚õî Az admin jogosults√°godat elvett√©k!\n\nVisszair√°ny√≠tunk a f≈ëoldalra.');
          // Azonnali √°tir√°ny√≠t√°s
          setTimeout(() => {
            window.location.href = getBaseUrl();
          }, 500);
        }
        
        // Ha kijelentkezt√ºnk
        if (!loggedIn) {
          // console.log('Kijelentkez√©s - √°tir√°ny√≠t√°s...');
          window.location.href = getBaseUrl();
        }
      });
      
      // Rendszeres admin check (h√°tt√©rben, 3 m√°sodpercenk√©nt)
      const intervalId = setInterval(() => {
        if (!auth || !auth.isAuthenticated()) {
          // console.warn('‚õî Nincs bejelentkezve - √°tir√°ny√≠t√°s...');
          clearInterval(intervalId);
          window.location.href = getBaseUrl();
          return;
        }
        
        if (!auth.isAdminUser()) {
          // console.warn('‚õî Nincs admin jog - √°tir√°ny√≠t√°s...');
          clearInterval(intervalId);
          alert('‚õî Az admin jogosults√°godat elvett√©k!');
          window.location.href = getBaseUrl();
        }
      }, 3000); // 3 m√°sodpercenk√©nt
    }
    
    
    // Ind√≠t√°s
    setupContinuousAdminCheck();
    
    // Glob√°lis hozz√°f√©r√©s
    window.toggleAdmin = toggleAdmin;
  </script>
  
  <!-- Google Drive f√°jlok kezel√©se √©s t√∂rl√©se -->
  <script type="module">
    import { getConfig, initializeGoogleDrive } from './assets/js/google-drive-api.js';
    import { getSupabaseClient } from './assets/js/supabase-client.js';
    
    // Haszn√°ljuk a m√°r l√©tez≈ë v√°ltoz√≥kat
    
    async function initGoogleDrive(supabaseOverride = null) {
      if (window.googleDriveInitialized) return;
      try {
        await initializeGoogleDrive(supabaseOverride || window.supabase);
        window.googleDriveInitialized = true;
        console.log('‚úÖ Google Drive inicializ√°lva');
      } catch (error) {
        console.error('‚ùå Google Drive init hiba:', error);
      }
    }
    
    // Google Drive f√°jlok friss√≠t√©se gomb
    const refreshDriveFilesBtn = document.getElementById('refreshDriveFilesBtn');
    if (refreshDriveFilesBtn) {
      refreshDriveFilesBtn.addEventListener('click', async () => {
        await loadGoogleDriveFiles();
      });
    }
    
    // ===================================
    // GOOGLE DRIVE F√ÅJLOK LIST√ÅZ√ÅSA
    // ===================================
    
    async function loadGoogleDriveFiles() {
      const driveFilesCount = document.getElementById('driveFilesCount');
      const driveFilesGrid = document.getElementById('driveFilesGrid');
      
      if (!driveFilesCount || !driveFilesGrid) return;
      
      try {
        driveFilesCount.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Bet√∂lt√©s...';
        driveFilesGrid.innerHTML = '';
        
        // Ellen≈ërizz√ºk, hogy van-e Google Drive konfigur√°ci√≥
        await initGoogleDrive();
        const config = getConfig();
        
        if (!config || !config.REFRESH_TOKEN) {
          driveFilesCount.innerHTML = '<span style="color: var(--muted);">‚ö†Ô∏è Nincs Google Drive bejelentkez√©s</span>';
          driveFilesGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 2rem;">Jelentkezz be a Google Drive-ba a f√°jlok megtekint√©s√©hez!</div>';
          return;
        }
        
        // F√°jlok list√°z√°sa
        const { listFilesInGoogleDrive } = await import('./assets/js/google-drive-api.js');
        const files = await listFilesInGoogleDrive();
        
        driveFilesCount.innerHTML = `<span style="color: var(--accent-light); font-weight: 600;">${files.length} f√°jl</span> tal√°lhat√≥ a mapp√°ban`;
        
        if (files.length === 0) {
          driveFilesGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 2rem;">üìÇ A mappa √ºres</div>';
          return;
        }
        
        // F√°jlok megjelen√≠t√©se k√°rty√°kk√©nt (infosharer st√≠lus)
        files.forEach(file => {
          const card = createFileCard(file);
          driveFilesGrid.appendChild(card);
        });
        
      } catch (error) {
        console.error('‚ùå Google Drive f√°jlok bet√∂lt√©si hiba:', error);
        driveFilesCount.innerHTML = '<span style="color: var(--error);">‚ùå Bet√∂lt√©si hiba</span>';
        driveFilesGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--error); padding: 2rem;">Hiba: ${error.message}</div>`;
      }
    }
    
    function createFileCard(file) {
      const card = document.createElement('div');
      card.style.cssText = `
        background: linear-gradient(135deg, var(--surface) 0%, rgba(127, 90, 240, 0.05) 100%);
        border: 1px solid rgba(127, 90, 240, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
      `;
      
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-4px)';
        card.style.boxShadow = '0 8px 16px rgba(127, 90, 240, 0.2)';
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = 'none';
      });
      
      // F√°jl ikon t√≠pus szerint
      const getFileIcon = (mimeType) => {
        if (mimeType.includes('image')) return 'üñºÔ∏è';
        if (mimeType.includes('video')) return 'üé•';
        if (mimeType.includes('audio')) return 'üéµ';
        if (mimeType.includes('pdf')) return 'üìÑ';
        if (mimeType.includes('zip') || mimeType.includes('rar')) return 'üì¶';
        if (mimeType.includes('text')) return 'üìù';
        return 'üìé';
      };
      
      // F√°jlm√©ret form√°z√°sa
      const formatSize = (bytes) => {
        if (!bytes) return 'Ismeretlen';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' kB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
      };
      
      // D√°tum form√°z√°sa
      const formatDate = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleString('hu-HU', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      };
      
      card.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
          <div style="font-size: 2.5rem;">${getFileIcon(file.mimeType)}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="color: var(--text); font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">
              ${file.name}
            </div>
            <div style="color: var(--muted); font-size: 0.85rem;">
              ${formatSize(file.size)}
            </div>
          </div>
        </div>
        
        <div style="color: var(--muted); font-size: 0.8rem; margin-bottom: 1rem;">
          üìÖ ${formatDate(file.createdTime)}
        </div>
        
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button class="download-btn" data-file-id="${file.id}" style="flex: 1; padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--accent), var(--accent-light)); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: opacity 0.2s;">
            ‚¨áÔ∏è Let√∂lt√©s
          </button>
          <button class="delete-btn" data-file-id="${file.id}" data-file-name="${file.name}" style="padding: 0.5rem 1rem; background: rgba(244, 67, 54, 0.1); color: #f44336; border: 1px solid rgba(244, 67, 54, 0.3); border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
            üóëÔ∏è T√∂rl√©s
          </button>
        </div>
      `;
      
      // Let√∂lt√©s gomb
      const downloadBtn = card.querySelector('.download-btn');
      downloadBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        await downloadFile(file.id, file.name, downloadBtn);
      });
      
      // T√∂rl√©s gomb
      const deleteBtn = card.querySelector('.delete-btn');
      deleteBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        await deleteFile(file.id, file.name, deleteBtn, card);
      });
      
      return card;
    }
    
    async function downloadFile(fileId, fileName, button) {
      try {
        button.disabled = true;
        button.textContent = '‚è≥ Let√∂lt√©s...';
        
        const { downloadFileFromGoogleDrive } = await import('./assets/js/google-drive-api.js');
        const blob = await downloadFileFromGoogleDrive(fileId);
        
        // Blob let√∂lt√©se
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        button.textContent = '‚úÖ Let√∂ltve!';
        setTimeout(() => {
          button.textContent = '‚¨áÔ∏è Let√∂lt√©s';
          button.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Let√∂lt√©si hiba:', error);
        alert('‚ùå Let√∂lt√©si hiba:\n\n' + error.message);
        button.textContent = '‚¨áÔ∏è Let√∂lt√©s';
        button.disabled = false;
      }
    }
    
    async function deleteFile(fileId, fileName, button, card) {
      if (!confirm(`üóëÔ∏è Biztosan t√∂r√∂lni szeretn√©d?\n\nF√°jl: ${fileName}\n\nEz a m≈±velet nem visszavonhat√≥!`)) {
        return;
      }
      
      try {
        button.disabled = true;
        button.textContent = '‚è≥ T√∂rl√©s...';
        
        const { deleteFileFromGoogleDrive } = await import('./assets/js/google-drive-api.js');
        await deleteFileFromGoogleDrive(fileId);
        
        // K√°rtya anim√°lt elt√°vol√≠t√°sa
        card.style.transition = 'all 0.3s ease';
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        
        setTimeout(() => {
          card.remove();
          // Sz√°ml√°l√≥k friss√≠t√©se
          const driveFilesCount = document.getElementById('driveFilesCount');
          const driveFilesGrid = document.getElementById('driveFilesGrid');
          const remainingFiles = driveFilesGrid.children.length;
          
          driveFilesCount.innerHTML = `<span style="color: var(--accent-light); font-weight: 600;">${remainingFiles} f√°jl</span> tal√°lhat√≥ a mapp√°ban`;
          
          if (remainingFiles === 0) {
            driveFilesGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 2rem;">üìÇ A mappa √ºres</div>';
          }
        }, 300);
        
      } catch (error) {
        console.error('‚ùå T√∂rl√©si hiba:', error);
        alert('‚ùå T√∂rl√©si hiba:\n\n' + error.message);
        button.textContent = 'üóëÔ∏è T√∂rl√©s';
        button.disabled = false;
      }
    }
    
    // Kezdeti bet√∂lt√©s
    loadGoogleDriveFiles();
  </script>
</body>
</html>
