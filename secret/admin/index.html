<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Admin Manager - Felhaszn√°l√≥k kezel√©se √©s admin jogosults√°gok" />
  <base href="../../" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <link rel="shortcut icon" href="assets/images/agazati.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/css/nav.css" />
  <link rel="stylesheet" href="assets/css/utilities.css" />
  <link rel="stylesheet" href="assets/css/footer.css" />
  <link rel="stylesheet" href="assets/css/infosharer.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="assets/js/admin-guard.js"></script>
  
  <title>Admin Manager - Agazati</title>
</head>
<body data-page-auth="true">
  <div id="mySidenav" class="sidenav"></div>
  <h2 class="cim subsite">Admin Manager</h2>

  <!-- Bejelentkez√©s el≈ëtti n√©zet -->
  <div id="loginView">
    <div class="meta">
      Ez az oldal csak admin felhaszn√°l√≥k sz√°m√°ra √©rhet≈ë el.
      <br />Jelentkezz be az admin jogosults√°gok kezel√©s√©hez.
    </div>
    <div class="controls" style="justify-content: center; margin-top: 2rem;">
      <button id="loginBtn" class="secondary">Bejelentkez√©s</button>
    </div>
  </div>

  <!-- Admin n√©zet -->
  <div id="mainView" style="display: none;">
    <div class="meta">
      Admin felhaszn√°l√≥k kezel√©se √©s jogosults√°gok m√≥dos√≠t√°sa
      <br />
      <span style="color: var(--accent-light); font-weight: 500;">
        Bejelentkezve mint: <span id="currentUserEmail">-</span>
      </span>
    </div>

    <!-- Felhaszn√°l√≥k lista -->
    <div class="container" style="max-width: 1200px; margin-top: 2rem;">
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 style="color: var(--text); margin: 0;">Regisztr√°lt Felhaszn√°l√≥k</h3>
            <button id="refreshBtn" class="ghost">Friss√≠t√©s</button>
          </div>
          
          <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border" role="status" style="color: var(--accent);">
              <span class="visually-hidden">Bet√∂lt√©s...</span>
            </div>
            <p class="mt-2" style="color: var(--muted);">Felhaszn√°l√≥k bet√∂lt√©se...</p>
          </div>

          <div id="usersTable" style="display: none;">
            <div class="table-responsive">
              <table class="table table-dark table-striped table-hover">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Regisztr√°ci√≥</th>
                    <th>Admin</th>
                    <th>M≈±veletek</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Felhaszn√°l√≥k dinamikusan t√∂lt≈ëdnek be ide -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="noUsers" style="display: none;" class="alert alert-info">
            M√©g nincsenek regisztr√°lt felhaszn√°l√≥k.
          </div>

          <div id="errorMessage" style="display: none;" class="alert alert-danger">
            Hiba t√∂rt√©nt a felhaszn√°l√≥k bet√∂lt√©se k√∂zben.
          </div>
        </div>
      </div>
    </div>

    <!-- Kijelentkez√©s gomb -->
    <div class="controls" style="justify-content: center; margin-top: 2rem;">
      <button id="logoutBtn" class="ghost">Kijelentkez√©s</button>
    </div>
  </div>

  <!-- √öj Supabase Auth Modal bet√∂lt√©se -->
  <div id="authModalContainer"></div>

  <style>
    #loginView {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      text-align: center;
    }

    .table {
      color: var(--text);
      margin-top: 1rem;
    }

    .table thead th {
      border-color: rgba(127, 90, 240, 0.3);
      background: rgba(127, 90, 240, 0.1);
      font-weight: 600;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background: rgba(127, 90, 240, 0.15) !important;
    }

    .table tbody td {
      vertical-align: middle;
      border-color: rgba(127, 90, 240, 0.2);
    }

    .badge {
      padding: 0.4rem 0.8rem;
      font-weight: 500;
    }

    .admin-badge {
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      color: white;
    }

    .user-badge {
      background: rgba(255, 255, 255, 0.1);
      color: var(--muted);
    }

    .action-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      margin: 0 0.2rem;
    }

    @media (max-width: 768px) {
      .table {
        font-size: 0.85rem;
      }

      .action-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
      }
    }
  </style>

  <script src="assets/js/nav.js"></script>
  <script src="assets/js/footer.js"></script>
  <script>
    // ===================================
    // ADMIN MANAGER
    // ===================================
    let auth;
    let authModal;
    let sb;

    // DOM elemek
    const loginView = document.getElementById('loginView');
    const mainView = document.getElementById('mainView');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserEmail = document.getElementById('currentUserEmail');
    const refreshBtn = document.getElementById('refreshBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const usersTable = document.getElementById('usersTable');
    const usersTableBody = document.getElementById('usersTableBody');
    const noUsers = document.getElementById('noUsers');
    const errorMessage = document.getElementById('errorMessage');

    // ===================================
    // INICIALIZ√ÅL√ÅS
    // ===================================
    document.addEventListener('DOMContentLoaded', async function() {
      // V√°runk a nav.js auth inicializ√°l√°s√°ra (max 10 m√°sodperc)
      // console.log('‚è≥ V√°rakoz√°s az auth inicializ√°l√°s√°ra...');
      let attempts = 0;
      while ((!window.getAuth || !window._agazati_auth_ready) && attempts < 100) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
        if (attempts % 10 === 0) {
          // console.log(`‚è≥ V√°rakoz√°s... ${attempts/10}s (getAuth: ${!!window.getAuth}, ready: ${!!window._agazati_auth_ready})`);
        }
      }
      
      // Supabase Auth megszerz√©se
      if (window.getAuth) {
        auth = window.getAuth();
        // console.log('‚úÖ Auth megszerezve');
      }
      
      // Ha m√©g mindig nincs auth, pr√≥b√°ljuk inicializ√°lni
      if (!auth && window.initSupabaseAuth) {
        // console.log('üîÑ Auth inicializ√°l√°sa manu√°lisan...');
        try {
          auth = await window.initSupabaseAuth();
          // console.log('‚úÖ Auth manu√°lisan inicializ√°lva');
        } catch (err) {
          console.error('‚ùå Auth inicializ√°l√°si hiba:', err);
        }
      }
      
      // Ha m√©g mindig nincs auth, hib√°t dobunk
      if (!auth) {
        console.error('‚ùå Auth inicializ√°l√°s sikertelen!');
        alert('Hiba t√∂rt√©nt az authentik√°ci√≥ bet√∂lt√©sekor. Friss√≠tsd az oldalt!');
        return;
      }
      
      // console.log('‚úÖ Auth ready:', auth.isAuthenticated() ? 'Bejelentkezve' : 'Nincs bejelentkezve');
      // console.log('üîë Admin status:', auth.isAdminUser());
      
      sb = auth.sb;

      // Auth Modal HTML bet√∂lt√©se - csak ha m√©g nincs
      let authModalContainer = document.getElementById('authModalContainer');
      if (!authModalContainer) {
        authModalContainer = document.createElement('div');
        authModalContainer.id = 'authModalContainer';
        document.body.appendChild(authModalContainer);
      }
      
      if (!authModalContainer.innerHTML.trim()) {
        const response = await fetch('assets/components/auth-modal.html');
        const html = await response.text();
        authModalContainer.innerHTML = html;
      }

      // Auth Modal inicializ√°l√°s
      authModal = new window.SupabaseAuthModal(auth);
      authModal.init({
        onSuccess: async () => {
          // V√°runk egy kicsit hogy a user_roles bet√∂lt≈ëdj√∂n
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Friss√≠tj√ºk a user profilt
          if (auth.currentUser) {
            await auth.loadUserProfile(auth.currentUser);
          }
          
          if (auth.isAdminUser()) {
            // console.log('‚úÖ Admin felhaszn√°l√≥, f≈ën√©zet megjelen√≠t√©se');
            await showMainView();
          } else {
            alert('‚ùå Nincs jogosults√°god az admin oldalakhoz! Csak admin felhaszn√°l√≥k √©rhetik el ezt az oldalt.');
            showLoginView();
          }
        },
        onCancel: () => {
          // Marad a login view
        }
      });

      // Login button click
      loginBtn?.addEventListener('click', () => {
        authModal.open();
      });

      // Logout button
      logoutBtn?.addEventListener('click', async () => {
        await auth.signOut();
        showLoginView();
        location.reload();
      });

      // Refresh button
      refreshBtn?.addEventListener('click', () => {
        loadUsers();
      });

      // Auto-login ellen≈ërz√©s
      if (auth.isAuthenticated()) {
        // console.log('Bejelentkezett felhaszn√°l√≥, admin jog ellen≈ërz√©se...');
        if (auth.isAdminUser()) {
          // console.log('‚úÖ Admin jogosults√°g van, f≈ën√©zet megjelen√≠t√©se');
          await showMainView();
        } else {
          // console.log('‚ùå Nincs admin jogosults√°g');
          alert('‚ùå Nincs jogosults√°god az admin oldalakhoz!');
          await auth.signOut();
          showLoginView();
        }
      } else {
        // console.log('Nincs bejelentkezve, login n√©zet megjelen√≠t√©se');
        showLoginView();
      }
    });

    // ===================================
    // VIEW KEZEL√âS
    // ===================================
    function showLoginView() {
      if (loginView) loginView.style.display = 'flex';
      if (mainView) mainView.style.display = 'none';
    }

    async function showMainView() {
      if (loginView) loginView.style.display = 'none';
      if (mainView) mainView.style.display = 'block';
      
      if (currentUserEmail) {
        currentUserEmail.textContent = auth.getUserEmail() || '-';
      }
      
      await loadUsers();
    }

    // ===================================
    // FELHASZN√ÅL√ìK BET√ñLT√âSE
    // ===================================
    async function loadUsers() {
      loadingSpinner.style.display = 'block';
      usersTable.style.display = 'none';
      noUsers.style.display = 'none';
      errorMessage.style.display = 'none';

      try {
        // El≈ësz√∂r lek√©rj√ºk a user_roles t√°bl√°t
        const { data: userRoles, error: rolesError } = await sb
          .from('user_roles')
          .select('*')
          .order('created_at', { ascending: false });

        if (rolesError) throw rolesError;

        // Megpr√≥b√°ljuk lek√©rni a profiles t√°bl√°t (ha l√©tezik)
        let profilesMap = new Map();
        try {
          const { data: profilesData } = await sb
            .from('profiles')
            .select('id, email');
          
          if (profilesData) {
            profilesData.forEach(p => profilesMap.set(p.id, p.email));
            // console.log('‚úÖ Profiles t√°bla bet√∂ltve:', profilesData.length, 'profil');
          }
        } catch (e) {
          // console.warn('‚ö†Ô∏è Profiles t√°bla nem l√©tezik - futtasd le a supabase-create-profiles-table.sql scriptet!');
        }

        // Felhaszn√°l√≥i adatok √∂ssze√°ll√≠t√°sa
        const currentUser = auth.currentUser;
        const usersWithDetails = userRoles.map(userRole => {
          let email = 'Ismeretlen';
          
          // 1. Pr√≥b√°ljuk a profiles t√°bl√°b√≥l
          if (profilesMap.has(userRole.user_id)) {
            email = profilesMap.get(userRole.user_id);
          }
          // 2. Ha ez az aktu√°lis user, haszn√°ljuk a session emailt
          else if (currentUser && currentUser.id === userRole.user_id) {
            email = currentUser.email || 'Ismeretlen';
          }
          // 3. Egy√©bk√©nt partial user ID
          else {
            email = `User ${userRole.user_id.substring(0, 8)}...`;
          }
          
          return {
            ...userRole,
            email: email
          };
        });

        loadingSpinner.style.display = 'none';

        if (usersWithDetails.length === 0) {
          noUsers.style.display = 'block';
          return;
        }

        // T√°bl√°zat felt√∂lt√©se
        usersTableBody.innerHTML = '';
        usersWithDetails.forEach(user => {
          const row = createUserRow(user);
          usersTableBody.appendChild(row);
        });

        usersTable.style.display = 'block';

      } catch (error) {
        console.error('Hiba a felhaszn√°l√≥k bet√∂lt√©sekor:', error);
        loadingSpinner.style.display = 'none';
        errorMessage.style.display = 'block';
        errorMessage.textContent = `Hiba: ${error.message}`;
      }
    }
    
    // Glob√°lis hozz√°f√©r√©s a real-time friss√≠t√©shez
    window.loadUsers = loadUsers;

    // ===================================
    // FELHASZN√ÅL√ì SOR L√âTREHOZ√ÅSA
    // ===================================
    function createUserRow(user) {
      const tr = document.createElement('tr');
      
      const isCurrentUser = user.user_id === auth.getUserId();
      
      tr.innerHTML = `
        <td>
          ${user.email}
          ${isCurrentUser ? '<span class="badge bg-info ms-2">Te</span>' : ''}
        </td>
        <td>${formatDate(user.created_at)}</td>
        <td>
          <span class="badge ${user.is_admin ? 'admin-badge' : 'user-badge'}">
            ${user.is_admin ? 'üëë Admin' : 'üë§ User'}
          </span>
        </td>
        <td>
          ${isCurrentUser ? 
            '<span class="text-muted">-</span>' : 
            `<button class="btn btn-sm ${user.is_admin ? 'btn-warning' : 'btn-success'} action-btn" 
              onclick="toggleAdmin('${user.user_id}', ${!user.is_admin})">
              ${user.is_admin ? '‚ùå Admin elt√°vol√≠t√°sa' : '‚úÖ Admin hozz√°ad√°sa'}
            </button>`
          }
        </td>
      `;
      
      return tr;
    }

    // ===================================
    // ADMIN TOGGLING
    // ===================================
    async function toggleAdmin(userId, makeAdmin) {
      const action = makeAdmin ? 'hozz√°ad√°sa' : 'elt√°vol√≠t√°sa';
      
      if (!confirm(`Biztos vagy benne, hogy ${makeAdmin ? 'admin jogot adsz' : 'elveszed az admin jogot'} ett≈ël a felhaszn√°l√≥t√≥l?`)) {
        return;
      }

      try {
        // console.log(`üîÑ Admin jog ${makeAdmin ? 'hozz√°ad√°sa' : 'elt√°vol√≠t√°sa'}: ${userId}`);
        
        const result = await auth.setUserAdmin(userId, makeAdmin);
        
        // console.log('‚úÖ Admin jog m√≥dos√≠tva:', result);
        
        alert(`‚úÖ Sikeresen ${makeAdmin ? 'hozz√°adtad az admin jogot' : 'elvetted az admin jogot'}!\n\nÔøΩ A felhaszn√°l√≥ automatikusan √©rtes√≠t√©st kap a v√°ltoz√°sr√≥l.`);
        // Ne h√≠vjuk meg a loadUsers()-t, a realtime subscription friss√≠ti automatikusan
      } catch (error) {
        console.error('‚ùå Hiba az admin jog m√≥dos√≠t√°sakor:', error);
        
        // R√©szletesebb hiba√ºzenet
        let errorMsg = error.message || 'Ismeretlen hiba';
        
        if (errorMsg.includes('function public.set_user_admin_metadata does not exist')) {
          errorMsg = '‚ö†Ô∏è Database funkci√≥ hi√°nyzik!\n\nFuttasd le a set-admin-metadata-function.sql scriptet a Supabase Dashboard-on (SQL Editor).';
        }
        
        alert(`‚ùå Hiba t√∂rt√©nt:\n\n${errorMsg}`);
      }
    }

    // ===================================
    // SEG√âDF√úGGV√âNYEK
    // ===================================
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('hu-HU', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Glob√°lis hozz√°f√©r√©s
    window.toggleAdmin = toggleAdmin;
  </script>
</body>
</html>
