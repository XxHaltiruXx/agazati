<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Itt tudsz infÃ³t osztani." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="../../" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="shortcut icon"
      href="assets/images/agazati.ico"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="./assets/css/base.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/nav.css" />
    <link rel="stylesheet" href="assets/css/utilities.css" />
    <link rel="stylesheet" href="assets/css/footer.css" />
    <link rel="stylesheet" href="assets/css/infosharer.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <title>Infosharer</title>
  </head>
  <body>
    <div id="mySidenav" class="sidenav"></div>
    <h2 class="cim subsite">Infosharer</h2>
    <div class="meta">
      Az oldal alapbÃ³l csak olvashatÃ³. Kattints az
      <strong>ÃrÃ¡s engedÃ©lyezÃ©se</strong>-re, add meg a jelszÃ³t, majd szerkeszd
      Ã©s mentsd.
    </div>
    <textarea id="shared" readonly placeholder="BetÃ¶ltÃ©s..."></textarea>

    <div class="controls">
      <div class="left">
        <div class="mainBtns">
          <button id="openPw" class="secondary">ÃrÃ¡s engedÃ©lyezÃ©se</button>
          <button id="copyBtn" class="ghost">MÃ¡solÃ¡s</button>
        </div>
        <div class="authBtns" id="authBtns" style="display: none">
          <button id="saveBtn" class="ghost" disabled>MentÃ©s</button>
          <button id="copyBtn2" class="ghost">MÃ¡solÃ¡s</button>
          <button id="logoutBtn" class="ghost">KijelentkezÃ©s</button>
        </div>
      </div>
      <div class="right">
        <div class="status" id="status">Kapcsolat: -</div>
      </div>
    </div>

    <!-- FÃ¡jl feltÃ¶ltÃ©s Ã©s slotok -->
    <div class="container mt-5" style="max-width: 1200px">
      <div class="row mb-4">
        <div class="col-12">
          <h3 class="text-center mb-4" style="color: var(--text)">
            FÃ¡jl Slots
          </h3>
          <div class="meta mb-4">
            Mindenki letÃ¶ltheti a fÃ¡jlokat. Csak bejelentkezett felhasznÃ¡lÃ³k
            tÃ¶lthetnek fel Ã©s tÃ¶rÃ¶lhetnek fÃ¡jlokat.
            <br /><span
              id="filesStatus"
              style="color: var(--muted); font-size: 0.9em"
              >FÃ¡jlok betÃ¶ltÃ©se...</span
            >
            <br />
            <div style="margin-top: 12px; padding: 10px; background: rgba(127, 90, 240, 0.1); border-radius: 8px; max-width: 400px; margin-left: auto; margin-right: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <span style="color: var(--text); font-weight: 500; font-size: 0.9em;">Ã–sszesen:</span>
                <span id="totalStorageDisplay" style="color: var(--accent-light); font-weight: bold; font-size: 0.9em;">0 MB / 50 MB</span>
              </div>
              <div style="height: 6px; background: #16162a; border-radius: 3px; overflow: hidden;">
                <div id="totalStorageBar" style="height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-light)); width: 0%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FÃ¡jl slotok grid -->
      <div class="row" id="slotContainer">
        <!-- Slotok itt jÃ¶nnek lÃ©tre dinamikusan -->
      </div>

      <!-- FÃ¡jl feltÃ¶ltÃ©s modal -->
      <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div
            class="modal-content"
            style="background: var(--bg-mid); border: 1px solid var(--accent)"
          >
            <div
              class="modal-header"
              style="border-bottom: 1px solid var(--accent)"
            >
              <h5 class="modal-title" style="color: var(--text); white-space: nowrap;">
                <span id="modalSlotTitle">Slot 1</span>
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
                style="filter: invert(1)"
              ></button>
            </div>
            <div class="modal-body">
              <!-- TÃ¡rhelyhasznÃ¡lat kijelzÅ‘ -->
              <div class="mb-3" id="storageInfo" style="
                background: rgba(127, 90, 240, 0.1);
                border: 1px solid var(--accent);
                border-radius: 8px;
                padding: 12px;
              ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="color: var(--text); font-weight: 500;">TÃ¡rhelyhasznÃ¡lat</span>
                  <span id="storageText" style="color: var(--accent-light); font-weight: bold;">0 MB / 50 MB</span>
                </div>
                <div style="
                  height: 8px;
                  background: #16162a;
                  border-radius: 4px;
                  overflow: hidden;
                ">
                  <div id="storageBar" style="
                    height: 100%;
                    background: linear-gradient(90deg, var(--accent), var(--accent-light));
                    width: 0%;
                    transition: width 0.3s ease;
                  "></div>
                </div>
                <div style="color: var(--muted); font-size: 0.85rem; margin-top: 4px;">
                  Szabad hely: <span id="freeSpace" style="color: var(--success);">50 MB</span>
                </div>
              </div>

              <!-- Drag & Drop fÃ¡jl feltÃ¶ltÃ©s -->
              <div class="mb-3">
                <label class="form-label" style="color: var(--text); font-weight: 500;">
                  VÃ¡lassz fÃ¡jlt vagy hÃºzd ide
                </label>
                <div id="dropZone" style="
                  border: 2px dashed var(--accent);
                  border-radius: 12px;
                  padding: 40px 20px;
                  text-align: center;
                  background: rgba(127, 90, 240, 0.05);
                  cursor: pointer;
                  transition: all 0.3s ease;
                  position: relative;
                ">
                  <input
                    class="form-control"
                    type="file"
                    id="fileUploadInput"
                    style="display: none;"
                  />
                  <div id="dropZoneContent">
                    <div style="font-size: 3rem; margin-bottom: 10px; color: var(--accent);">â¬†</div>
                    <div style="color: var(--text); font-weight: 500; margin-bottom: 8px;">
                      Kattints vagy hÃºzd ide a fÃ¡jlt
                    </div>
                    <div style="color: var(--muted); font-size: 0.9rem;">
                      MaximÃ¡lis fÃ¡jlmÃ©ret: 50 MB
                    </div>
                  </div>
                </div>
              </div>
              <div
                id="fileInfo"
                style="
                  display: none;
                  padding: 10px;
                  background: rgba(127, 90, 240, 0.1);
                  border-radius: 6px;
                  margin-bottom: 15px;
                "
              >
                <div style="color: var(--text)">
                  <strong>KivÃ¡lasztott fÃ¡jl:</strong>
                  <span id="selectedFileName"></span>
                </div>
                <div style="color: var(--muted)" id="selectedFileSize"></div>
              </div>
              <div id="uploadProgress" style="display: none">
                <div
                  class="progress"
                  style="
                    height: 8px;
                    background: #16162a;
                    border-radius: 4px;
                    overflow: hidden;
                  "
                >
                  <div
                    id="uploadProgressBar"
                    class="progress-bar"
                    role="progressbar"
                    style="background: var(--accent); width: 0%"
                  ></div>
                </div>
                <div
                  id="uploadProgressText"
                  class="text-center mt-2"
                  style="color: var(--muted)"
                >
                  FeltÃ¶ltÃ©s...
                </div>
              </div>
            </div>
            <div
              class="modal-footer"
              style="border-top: 1px solid var(--accent)"
            >
              <button type="button" class="btn ghost" data-bs-dismiss="modal">
                MÃ©gse
              </button>
              <button type="button" class="btn secondary" id="confirmUpload">
                FeltÃ¶ltÃ©s
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- FÃ¡jl informÃ¡ciÃ³k modal -->
      <div class="modal fade" id="fileInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="background: var(--bg-mid); border: 1px solid var(--accent)">
            <div class="modal-header" style="border-bottom: 1px solid var(--accent)">
              <h5 class="modal-title" style="color: var(--text); white-space: nowrap;">
                <span id="infoModalSlotTitle">Slot 1</span>
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1)"></button>
            </div>
            <div class="modal-body">
              <!-- FÃ¡jl elÅ‘nÃ©zet / Ikon -->
              <div id="filePreviewSection" class="text-center mb-4" style="display: none;">
                <img id="filePreviewImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin: 0 auto 10px auto; display: none;" />
              </div>
              <div id="fileIconSection" class="text-center mb-4" style="display: none;">
                <div id="fileIconLarge" style="font-size: 4rem; margin-bottom: 10px;">ğŸ“„</div>
              </div>

              <!-- FÃ¡jl rÃ©szletek -->
              <div style="background: rgba(127, 90, 240, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: grid; gap: 12px;">
                  <div>
                    <span style="color: var(--muted); font-size: 0.9em;">FÃ¡jlnÃ©v:</span>
                    <div id="infoFileName" style="color: var(--text); font-weight: 500; word-break: break-all;"></div>
                  </div>
                  <div>
                    <span style="color: var(--muted); font-size: 0.9em;">MÃ©ret:</span>
                    <div id="infoFileSize" style="color: var(--accent-light); font-weight: 500;"></div>
                  </div>
                  <div>
                    <span style="color: var(--muted); font-size: 0.9em;">FeltÃ¶ltve:</span>
                    <div id="infoFileDate" style="color: var(--text);"></div>
                  </div>
                </div>
              </div>

              <!-- Link generÃ¡lÃ¡s Ã©s mÃ¡solÃ¡s -->
              <div style="background: rgba(127, 90, 240, 0.05); border: 1px solid var(--accent); border-radius: 8px; padding: 15px;">
                <h6 style="color: var(--accent-light); margin-bottom: 12px;">MegoszthatÃ³ Link</h6>
                
                <div class="mb-3">
                  <label for="linkExpirySelect" class="form-label" style="color: var(--text); font-size: 0.9em;">Link Ã©rvÃ©nyessÃ©ge:</label>
                  <select id="linkExpirySelect" class="form-select" style="background: var(--bg-dark); color: var(--text); border: 1px solid var(--accent);">
                    <option value="3600">1 Ã³ra</option>
                    <option value="21600">6 Ã³ra</option>
                    <option value="86400" selected>24 Ã³ra (1 nap)</option>
                    <option value="259200">3 nap</option>
                    <option value="604800">7 nap (1 hÃ©t)</option>
                  </select>
                </div>

                <button id="generateLinkBtn" class="btn w-100 mb-2" style="background: var(--accent); color: white; font-weight: 500;">
                  ğŸ”— Link generÃ¡lÃ¡sa
                </button>

                <div id="generatedLinkSection" style="display: none;">
                  <div style="background: var(--bg-dark); border: 1px solid var(--accent); border-radius: 6px; padding: 15px; text-align: center;">
                    <div style="color: var(--muted); font-size: 0.85em; margin-bottom: 10px;">Link automatikusan vÃ¡gÃ³lapra mÃ¡solva:</div>
                    <div id="generatedLinkDisplay" style="color: var(--accent-light); font-size: 0.95em; font-family: monospace; word-break: break-all; padding: 10px; background: rgba(127, 90, 240, 0.1); border-radius: 6px; margin-bottom: 10px;"></div>
                    <div style="color: var(--success); font-size: 0.85em;">
                      Ã‰rvÃ©nyes: <span id="linkExpiryText"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--accent); gap: 8px;">
              <button id="infoDownloadBtn" class="btn" style="background: var(--accent); color: white; flex: 1;">
                LetÃ¶ltÃ©s
              </button>
              <button id="infoDeleteBtn" class="btn ghost" style="color: var(--error); border-color: var(--error); flex: 1;" data-requires-auth="true">
                TÃ¶rlÃ©s
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- FÃ¡jl tÃ¶rlÃ©s megerÅ‘sÃ­tÃ©s modal -->
      <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div
            class="modal-content"
            style="background: var(--bg-mid); border: 1px solid var(--accent)"
          >
            <div
              class="modal-header"
              style="border-bottom: 1px solid var(--accent)"
            >
              <h5 class="modal-title" style="color: var(--text)">
                FÃ¡jl tÃ¶rlÃ©se
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
                style="filter: invert(1)"
              ></button>
            </div>
            <div class="modal-body">
              <p style="color: var(--text)">
                Biztosan tÃ¶rÃ¶lni szeretnÃ©d ezt a fÃ¡jlt?
              </p>
              <p
                id="deleteFileName"
                style="
                  color: var(--accent-light);
                  font-weight: bold;
                  word-break: break-all;
                "
              ></p>
            </div>
            <div
              class="modal-footer"
              style="border-top: 1px solid var(--accent)"
            >
              <button type="button" class="btn ghost" data-bs-dismiss="modal">
                MÃ©gse
              </button>
              <button
                type="button"
                class="btn"
                id="confirmDelete"
                style="background: var(--error); color: white"
              >
                TÃ¶rlÃ©s
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="pwModal"
      style="display: none"
      aria-hidden="true"
      role="dialog"
      tabindex="-1"
    >
      <div id="pwBox" role="document" tabindex="0">
        <h2 style="margin: 0 0 8px">ÃrÃ¡s jelszÃ³val</h2>
        <div
          style="font-size: 0.95rem; color: var(--muted); margin-bottom: 10px"
        >
          Ãrd be a jelszÃ³t, hogy szerkeszthess.
        </div>
        <div class="password-container">
          <div class="password-inner">
            <input
              id="pwInput"
              type="password"
              autocomplete="off"
              placeholder="JelszÃ³"
            />
            <span
              class="toggle-password"
              id="togglePassword"
              role="button"
              tabindex="0"
            ></span>
          </div>
        </div>
        <div class="remember-container">
          <input type="checkbox" id="rememberMe" />
          <label for="rememberMe">EmlÃ©kezz rÃ¡m</label>
        </div>
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
          "
        >
          <button id="pwCancel" class="ghost">MÃ©gse</button>
          <button id="pwOk">BejelentkezÃ©s</button>
        </div>
        <div class="error" id="pwNote">Helytelen jelszÃ³</div>
        <div class="info" id="pwInfo">Sikeres â€” Ã­rÃ¡s engedÃ©lyezve</div>
        <small class="hint"
          >SzÃ³kÃ¶z a bevitelnÃ©l: a jelszÃ³ trim-elve lesz (vÃ©letlen szÃ³kÃ¶zÃ¶k
          eltÃ¡volÃ­tÃ¡sa).</small
        >
      </div>
    </div>

    <script type="module">
      const SUPABASE_URL = "https://ccpuoqrbmldunshaxpes.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjcHVvcXJibWxkdW5zaGF4cGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE2MDUsImV4cCI6MjA3ODA4NzYwNX0.QpVCmzF96Fp5hdgFyR0VkT9RV6qKiLkA8Yv_LArSk5I";
      const PASSWORD_HASH =
        "248e464b6e49676c615430dbfb831787d3d7c78e52bd2cb2461608991f7204f6";
      const TABLE = "infosharer";
      const ID = 1;
      const BUCKET_NAME = "infosharer-uploads";
      const MAX_STORAGE_BYTES = 50 * 1024 * 1024; // 50 MB Ã¶sszesen
      const MAX_FILE_SIZE_BYTES = 50 * 1024 * 1024; // 50 MB per file
      const REMEMBER_ME_KEY = "infosharer_remember_token";
      const SITEWIDE_LOGIN_KEY = "__agazati_login_state";
      const SITEWIDE_LOGIN_EXPIRY = "__agazati_login_expiry";
      const REMEMBER_DURATION = 365 * 24 * 60 * 60 * 1000;
      const SITEWIDE_LOGIN_DURATION = 24 * 60 * 60 * 1000; // 24 Ã³ra

      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Elemek
      const ta = document.getElementById("shared");
      const openPw = document.getElementById("openPw");
      const pwModal = document.getElementById("pwModal");
      const pwInput = document.getElementById("pwInput");
      const pwOk = document.getElementById("pwOk");
      const pwCancel = document.getElementById("pwCancel");
      const pwNote = document.getElementById("pwNote");
      const pwInfo = document.getElementById("pwInfo");
      const saveBtn = document.getElementById("saveBtn");
      const statusEl = document.getElementById("status");
      const copyBtn = document.getElementById("copyBtn");
      const copyBtn2 = document.getElementById("copyBtn2");
      const authBtns = document.getElementById("authBtns");
      const mainBtns = document.querySelector(".mainBtns");
      const togglePassword = document.getElementById("togglePassword");
      const rememberMe = document.getElementById("rememberMe");
      const logoutBtn = document.getElementById("logoutBtn");

      // FÃ¡jlkezelÃ©s elemei
      const slotContainer = document.getElementById("slotContainer");
      const filesStatus = document.getElementById("filesStatus");
      const uploadModal = new bootstrap.Modal(
        document.getElementById("uploadModal")
      );
      const deleteModal = new bootstrap.Modal(
        document.getElementById("deleteModal")
      );
      const fileInfoModal = new bootstrap.Modal(
        document.getElementById("fileInfoModal")
      );
      const fileUploadInput = document.getElementById("fileUploadInput");
      const modalSlotTitle = document.getElementById("modalSlotTitle");
      const selectedFileName = document.getElementById("selectedFileName");
      const selectedFileSize = document.getElementById("selectedFileSize");
      const fileInfo = document.getElementById("fileInfo");
      const uploadProgress = document.getElementById("uploadProgress");
      const uploadProgressBar = document.getElementById("uploadProgressBar");
      const uploadProgressText = document.getElementById("uploadProgressText");
      const confirmUpload = document.getElementById("confirmUpload");
      const deleteFileName = document.getElementById("deleteFileName");
      const confirmDelete = document.getElementById("confirmDelete");

      let canEdit = false;
      let channelRef = null;
      let currentSlot = null;
      let currentFileInfoSlot = null;
      let fileToDelete = null;
      let fileChannel = null;

      // FÃ¡jlok Ã©s slotok lekÃ©pezÃ©se (dinamikus)
      let slotMappings = {};
      let totalStorageUsed = 0; // Bytes

      // SzÃ¶veg betÃ¶ltÃ©se
      async function load() {
        try {
          const { data, error } = await supabase
            .from(TABLE)
            .select("content")
            .eq("id", ID)
            .limit(1)
            .single();
          if (error || !data) return;
          if (canEdit && document.activeElement === ta) return;
          const newContent = data.content || "";
          if (newContent !== ta.value) ta.value = newContent;
        } catch (err) {
          console.error("Load error", err);
        }
      }

      // SzÃ¶veg mentÃ©se
      async function upsert(text) {
        try {
          await supabase
            .from(TABLE)
            .upsert({ id: ID, content: text }, { onConflict: "id" });
        } catch (err) {
          console.error("Upsert error", err);
          alert("MentÃ©s hiba (nÃ©zd a konzolt)");
        }
      }

      // Kapcsolat Ã¡llapota
      function setStatusFromState(state) {
        let s = (state || "").toString().toLowerCase();
        if (s === "closed" || s === "megszakadt" || s === "closedconnection") {
          s = "megszakadt";
          statusEl.dataset.state = s;
          statusEl.textContent = "Kapcsolat: megszakadt";
        } else {
          s = "Ã©lÅ‘";
          statusEl.dataset.state = s;
          statusEl.textContent = "Kapcsolat: Ã©lÅ‘";
        }
      }

      function setFilesStatus(state, message = "") {
        if (!filesStatus) return;

        let text = "";
        let color = "";

        switch (state) {
          case "loading":
            text = "FÃ¡jlok betÃ¶ltÃ©se...";
            color = "var(--muted)";
            break;
          case "success":
            text = message || "FÃ¡jlok betÃ¶ltve";
            color = "var(--success)";
            break;
          case "error":
            text = message || "Hiba a fÃ¡jlok betÃ¶ltÃ©sekor";
            color = "var(--error)";
            break;
          case "updated":
            text = message || "FÃ¡jlok frissÃ­tve";
            color = "var(--accent-light)";
            break;
          default:
            text = "FÃ¡jlok kÃ©szen";
            color = "var(--muted)";
        }

        filesStatus.textContent = text;
        filesStatus.style.color = color;
      }

      // Real-time elÅ‘fizetÃ©s a szÃ¶veghez
      function subscribeRealtime() {
        try {
          const channelName = "public:" + TABLE;
          channelRef = supabase.channel(channelName).on(
            "postgres_changes",
            {
              event: "*",
              schema: "public",
              table: TABLE,
              filter: `id=eq.${ID}`,
            },
            (payload) => {
              const row = payload?.new;
              if (row) {
                if (!(canEdit && document.activeElement === ta)) {
                  ta.value = row.content || "";
                }
              }
            }
          );
          const sub = channelRef.subscribe((statusOrObj) => {
            try {
              if (!statusOrObj) {
                setStatusFromState("ismeretlen");
              } else if (typeof statusOrObj === "string") {
                const normalized =
                  statusOrObj === "SUBSCRIBED"
                    ? "Ã©lÅ‘"
                    : statusOrObj === "CLOSED"
                    ? "megszakadt"
                    : statusOrObj;
                setStatusFromState(normalized);
              } else if (typeof statusOrObj === "object") {
                const s = statusOrObj.status || statusOrObj;
                const normalized =
                  s === "SUBSCRIBED"
                    ? "Ã©lÅ‘"
                    : s === "CLOSED"
                    ? "megszakadt"
                    : s;
                setStatusFromState(normalized);
              } else {
                setStatusFromState(String(statusOrObj));
              }
            } catch (e) {
              setStatusFromState("megszakadt");
            }
          });
          sub.on("error", (err) => {
            setStatusFromState("megszakadt");
          });
        } catch (err) {
          setStatusFromState("megszakadt");
        }
      }

      // Real-time elÅ‘fizetÃ©s a fÃ¡jlokhoz (polling)
      function subscribeFileRealtime() {
        // Polling minden 3 mÃ¡sodpercben a fÃ¡jlok frissÃ­tÃ©sÃ©hez
        setInterval(async () => {
          try {
            await updateSlots(true); // true = csendes frissÃ­tÃ©s (nem jelenÃ­t Ãºj Ã¼zenetet)
          } catch (err) {
            console.error("FÃ¡jl frissÃ­tÃ©si hiba:", err);
          }
        }, 3000);
      }

      // FÃ¡jl ikon alapjÃ¡n a kiterjesztÃ©s alapjÃ¡n
      function getFileIcon(filename) {
        if (!filename) return "ğŸ“";
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "ğŸ“•",
          doc: "ğŸ“˜",
          docx: "ğŸ“˜",
          xls: "ğŸ“—",
          xlsx: "ğŸ“—",
          ppt: "ğŸ““",
          pptx: "ğŸ““",
          txt: "ğŸ“„",
          zip: "ğŸ“¦",
          rar: "ğŸ“¦",
          "7z": "ğŸ“¦",
          tar: "ğŸ“¦",
          gz: "ğŸ“¦",
          jpg: "ğŸ–¼ï¸",
          jpeg: "ğŸ–¼ï¸",
          png: "ğŸ–¼ï¸",
          gif: "ğŸ–¼ï¸",
          bmp: "ğŸ–¼ï¸",
          svg: "ğŸ–¼ï¸",
          webp: "ğŸ–¼ï¸",
          mp3: "ğŸµ",
          wav: "ğŸµ",
          ogg: "ğŸµ",
          flac: "ğŸµ",
          mp4: "ğŸ¬",
          avi: "ğŸ¬",
          mov: "ğŸ¬",
          mkv: "ğŸ¬",
          wmv: "ğŸ¬",
          flv: "ğŸ¬",
          exe: "âš™ï¸",
          html: "ğŸŒ",
          htm: "ğŸŒ",
          css: "ğŸ¨",
          js: "ğŸ“œ",
          py: "ğŸ",
          java: "â˜•",
          cpp: "âš¡",
          c: "âš¡",
          json: "ğŸ“‹",
          xml: "ğŸ“„",
          sql: "ğŸ—„ï¸",
          psd: "ğŸ¨",
          ai: "âœï¸",
          sketch: "âœï¸",
          md: "ğŸ“",
          csv: "ğŸ“Š",
          rtf: "ğŸ“„",
          dmg: "ğŸ’¿",
          iso: "ğŸ’¿",
        };
        return icons[ext] || "ğŸ“";
      }

      // FÃ¡jlmÃ©ret formÃ¡zÃ¡sa
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";

        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Egyedi rÃ¶vid kÃ³d generÃ¡lÃ¡sa
      function generateShortCode(slotNumber, fileName) {
        // Slot szÃ¡m + fÃ¡jlnÃ©v elsÅ‘ 3 karaktere + random 3 karakter
        const filePrefix = fileName.replace(/^slot\d+_/, '').substring(0, 3).toUpperCase();
        const randomChars = Math.random().toString(36).substring(2, 5).toUpperCase();
        return `S${slotNumber}-${filePrefix}${randomChars}`;
      }

      // LetÃ¶ltÃ©si link generÃ¡lÃ¡sa megosztÃ¡shoz
      async function getDownloadLink(fileName, originalName, expirySeconds = 86400, slotNumber = 0) {
        try {
          // ElÅ‘szÃ¶r ellenÅ‘rizzÃ¼k, hogy lÃ©tezik-e a fÃ¡jl
          const { data: fileExists, error: checkError } = await supabase.storage
            .from(BUCKET_NAME)
            .list('', {
              search: fileName
            });

          if (checkError) {
            console.error('FÃ¡jl ellenÅ‘rzÃ©si hiba:', checkError);
            throw new Error('Nem sikerÃ¼lt ellenÅ‘rizni a fÃ¡jl lÃ©tezÃ©sÃ©t');
          }

          if (!fileExists || fileExists.length === 0) {
            setFilesStatus('error', 'A fÃ¡jl nem talÃ¡lhatÃ³ vagy tÃ¶rÃ¶lve lett');
            throw new Error('A fÃ¡jl nem talÃ¡lhatÃ³');
          }

          // Ha lÃ©tezik, generÃ¡lunk egy signed URL-t a megadott Ã©rvÃ©nyessÃ©ggel
          const { data: signedUrlData, error: signedError } = await supabase.storage
            .from(BUCKET_NAME)
            .createSignedUrl(fileName, expirySeconds);

          if (signedError) {
            console.error('Signed URL generÃ¡lÃ¡si hiba:', signedError);
            throw signedError;
          }

          // A signed URL-t emberi olvashatÃ³ formÃ¡ba csomagoljuk
          const downloadUrl = signedUrlData.signedUrl;
          const displayName = originalName || fileName.replace(/^slot\d+_/, '');
          
          // Ã‰rvÃ©nyessÃ©g szÃ¶vege
          let expiryText = '';
          if (expirySeconds < 3600) {
            expiryText = `${Math.floor(expirySeconds / 60)} percig`;
          } else if (expirySeconds < 86400) {
            expiryText = `${Math.floor(expirySeconds / 3600)} Ã³rÃ¡ig`;
          } else {
            expiryText = `${Math.floor(expirySeconds / 86400)} napig`;
          }
          
          // Egyedi rÃ¶vid kÃ³d generÃ¡lÃ¡sa
          const shortCode = generateShortCode(slotNumber, fileName);
          const baseUrl = window.location.origin + window.location.pathname;
          const customLink = `${baseUrl}?file=${shortCode}`;
          
          // Visszaadjuk a letÃ¶ltÃ©si linket egyszerÅ±bb formÃ¡tumban
          return {
            url: downloadUrl,
            fileName: displayName,
            expiryText: expiryText,
            shortCode: shortCode,
            customLink: customLink,
            formattedLink: `Slot ${slotNumber}: ${displayName}\n Egyedi kÃ³d: ${shortCode}\n Ã‰rvÃ©nyes: ${expiryText}\n\n EgyszerÅ± link:\n${customLink}\n\n Direkt letÃ¶ltÃ©si link:\n${downloadUrl}`
          };
        } catch (err) {
          console.error('Download link generÃ¡lÃ¡si hiba:', err);
          throw err;
        }
      }

      // Slot-hez tartozÃ³ fÃ¡jl letÃ¶ltÃ©se - JAVÃTOTT VERZIÃ“
      async function downloadFile(fileName, originalName) {
        try {
          // ElÅ‘szÃ¶r ellenÅ‘rizzÃ¼k, hogy lÃ©tezik-e a fÃ¡jl
          const { data: fileExists, error: checkError } = await supabase.storage
            .from(BUCKET_NAME)
            .list('', {
              search: fileName
            });

          if (checkError) {
            console.error('FÃ¡jl ellenÅ‘rzÃ©si hiba:', checkError);
            setFilesStatus('error', 'Hiba a fÃ¡jl ellenÅ‘rzÃ©sekor');
            return;
          }

          if (!fileExists || fileExists.length === 0) {
            setFilesStatus('error', 'A fÃ¡jl nem talÃ¡lhatÃ³ vagy tÃ¶rÃ¶lve lett. FrissÃ­tsd az oldalt!');
            // FrissÃ­tjÃ¼k a slot-okat
            setTimeout(() => {
              loadSlots();
            }, 2000);
            return;
          }

          // Ha lÃ©tezik, folytatjuk a letÃ¶ltÃ©st
          // Blob letÃ¶ltÃ©s - ez mindig letÃ¶lti, nem nyitja meg
          const { data, error } = await supabase.storage
            .from(BUCKET_NAME)
            .download(fileName);

          if (error) {
            console.error("LetÃ¶ltÃ©si hiba:", error);
            throw error;
          }

          // Blob URL lÃ©trehozÃ¡sa
          const url = URL.createObjectURL(data);

          // LÃ©trehozunk egy lÃ¡thatatlan linket
          const a = document.createElement("a");
          a.href = url;
          a.download = originalName || fileName.replace(/^slot\d+_/, ""); // EltÃ¡volÃ­tjuk a slot elÅ‘tagot
          a.style.display = "none";
          document.body.appendChild(a);

          // KattintÃ¡s a linkre
          a.click();

          // TakarÃ­tÃ¡s
          setTimeout(() => {
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
          }, 100);

          // Sikeres letÃ¶ltÃ©s visszajelzÃ©s
          setFilesStatus("success", "âœ“ FÃ¡jl letÃ¶ltÃ©se elkezdÅ‘dÃ¶tt");
        } catch (err) {
          console.error("Blob letÃ¶ltÃ©si hiba, alternatÃ­v mÃ³dszer:", err);

          // AlternatÃ­v mÃ³dszer: signed URL letÃ¶ltÃ©se
          try {
            const { data: signedUrlData, error: signedError } =
              await supabase.storage
                .from(BUCKET_NAME)
                .createSignedUrl(fileName, 60); // 60 mÃ¡sodpercig Ã©rvÃ©nyes

            if (signedError) throw signedError;

            // LÃ©trehozunk egy lÃ¡thatatlan linket a signed URL-lel
            const a = document.createElement("a");
            a.href = signedUrlData.signedUrl;
            a.download = originalName || fileName.replace(/^slot\d+_/, "");
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
              document.body.removeChild(a);
            }, 100);
          } catch (signedErr) {
            console.error("Signed URL hiba:", signedErr);

            // VisszaesÃ©s a nyilvÃ¡nos URL-re
            const { data: publicUrlData } = supabase.storage
              .from(BUCKET_NAME)
              .getPublicUrl(fileName);

            // PrÃ³bÃ¡ljuk meg a letÃ¶ltÃ©st a download attribÃºtummal
            const a = document.createElement("a");
            a.href = publicUrlData.publicUrl;
            a.download = originalName || fileName.replace(/^slot\d+_/, "");
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
              document.body.removeChild(a);
            }, 100);
          }
        }
      }

      // TÃ¡rhelyhasznÃ¡lat szÃ¡mÃ­tÃ¡sa
      function calculateStorageUsage() {
        totalStorageUsed = 0;
        Object.values(slotMappings).forEach(fileData => {
          if (fileData && fileData.metadata && fileData.metadata.size) {
            totalStorageUsed += fileData.metadata.size;
          }
        });
        return totalStorageUsed;
      }

      // TÃ¡rhelyhasznÃ¡lat frissÃ­tÃ©se a modal-ban
      function updateStorageDisplay() {
        const storageBar = document.getElementById('storageBar');
        const storageText = document.getElementById('storageText');
        const freeSpace = document.getElementById('freeSpace');
        
        if (!storageBar || !storageText || !freeSpace) return;
        
        const usedMB = (totalStorageUsed / (1024 * 1024)).toFixed(2);
        const totalMB = (MAX_STORAGE_BYTES / (1024 * 1024)).toFixed(0);
        const freeMB = ((MAX_STORAGE_BYTES - totalStorageUsed) / (1024 * 1024)).toFixed(2);
        const percentage = (totalStorageUsed / MAX_STORAGE_BYTES) * 100;
        
        storageBar.style.width = `${percentage}%`;
        storageText.textContent = `${usedMB} MB / ${totalMB} MB`;
        freeSpace.textContent = `${freeMB} MB`;
        
        // SzÃ­nvÃ¡ltÃ¡s a hasznÃ¡lat alapjÃ¡n
        if (percentage > 90) {
          storageBar.style.background = 'var(--error)';
          freeSpace.style.color = 'var(--error)';
        } else if (percentage > 70) {
          storageBar.style.background = 'orange';
          freeSpace.style.color = 'orange';
        } else {
          storageBar.style.background = 'linear-gradient(90deg, var(--accent), var(--accent-light))';
          freeSpace.style.color = 'var(--success)';
        }
      }

      // Slotok lÃ©trehozÃ¡sa Ã©s frissÃ­tÃ©se
      async function updateSlots(silent = false) {
        try {
          if (!silent) {
            setFilesStatus("loading");
          }

          const { data, error } = await supabase.storage
            .from(BUCKET_NAME)
            .list("");

          if (error) {
            console.error("FÃ¡jllista hiba:", error);
            setFilesStatus("error", "Hiba a fÃ¡jlok betÃ¶ltÃ©sekor");
            return;
          }

          // ReseteljÃ¼k a slot lekÃ©pezÃ©seket
          slotMappings = {};

          // FÃ¡jlok hozzÃ¡rendelÃ©se a slotokhoz a fÃ¡jlnÃ©v alapjÃ¡n
          if (data && data.length > 0) {
            data.forEach((file) => {
              // MegnÃ©zzÃ¼k, hogy a fÃ¡jlnÃ©v tartalmaz-e slot szÃ¡mot
              const match = file.name.match(/slot(\d+)_(.+)/);
              if (match) {
                const slotNum = parseInt(match[1]);
                let originalName = match[2];
                
                slotMappings[slotNum] = {
                  fileName: file.name,
                  originalName: originalName,
                  metadata: file.metadata,
                  created_at: file.created_at,
                };
              }
            });
          }

          // TÃ¡rhelyhasznÃ¡lat szÃ¡mÃ­tÃ¡sa
          calculateStorageUsage();

          slotContainer.innerHTML = "";

          // Slot szÃ¡mok rendezÃ©se
          const slotNumbers = Object.keys(slotMappings).map(n => parseInt(n)).sort((a, b) => a - b);
          const maxSlotNum = slotNumbers.length > 0 ? Math.max(...slotNumbers) : 0;
          
          // LÃ©trehozzuk a slotokat
          const slotsToCreate = canEdit ? maxSlotNum + 1 : maxSlotNum;
          
          for (let i = 1; i <= slotsToCreate; i++) {
            const fileData = slotMappings[i];
            const isFilled = fileData ? true : false;

            const col = document.createElement("div");
            col.className = "col-md-3 col-sm-6 mb-4";

            const card = document.createElement("div");
            card.className = "card h-100";
            card.style.cssText = `
        background: var(--bg-mid);
        border: 2px solid ${isFilled ? "var(--accent)" : "var(--muted)"};
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
      `;

            if (isFilled) {
              card.style.boxShadow = "0 4px 15px rgba(127, 90, 240, 0.2)";
            }
            //dsadsa 

            const cardBody = document.createElement("div");
            cardBody.className = "card-body d-flex flex-column";

            // FÃ¡jl ikon vagy kÃ©p elÅ‘nÃ©zet
            const iconContainer = document.createElement("div");
            iconContainer.className = "text-center mb-3";
            iconContainer.style.cssText = "font-size: 3.5rem; position: relative;";

            // EllenÅ‘rizzÃ¼k, hogy kÃ©p-e
            const isImage = fileData && fileData.originalName && /\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(fileData.originalName);
            
            if (isFilled && isImage) {
              // KÃ©p elÅ‘nÃ©zet
              const imgPreview = document.createElement("div");
              imgPreview.style.cssText = `
                width: 100%;
                height: 150px;
                border-radius: 8px;
                overflow: hidden;
                background: #16162a;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
              `;
              
              const img = document.createElement("img");
              img.style.cssText = `
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                border-radius: 8px;
              `;
              
              // KÃ©p URL lekÃ©rÃ©se
              const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(fileData.fileName);
              
              img.src = publicUrlData.publicUrl;
              img.alt = fileData.originalName;
              
              // BetÃ¶ltÃ©si spinner
              const loadingSpinner = document.createElement("div");
              loadingSpinner.style.cssText = `
                position: absolute;
                font-size: 2rem;
              `;
              loadingSpinner.textContent = "â³";
              imgPreview.appendChild(loadingSpinner);
              
              img.onload = () => {
                loadingSpinner.remove();
              };
              
              img.onerror = () => {
                loadingSpinner.textContent = "ğŸ–¼ï¸";
                loadingSpinner.style.fontSize = "3rem";
              };
              
              imgPreview.appendChild(img);
              iconContainer.appendChild(imgPreview);
            } else {
              // NormÃ¡l fÃ¡jl ikon
              const fileIcon = document.createElement("div");
              fileIcon.textContent = getFileIcon(fileData?.originalName || "");
              fileIcon.style.cssText = "display: inline-block;";
              iconContainer.appendChild(fileIcon);
            }

            // Slot cÃ­m
            const slotTitle = document.createElement("h5");
            slotTitle.className = "card-title text-center mb-3";
            slotTitle.style.cssText = "color: var(--text); font-weight: bold;";
            slotTitle.textContent = `Slot ${i}`;

            // FÃ¡jl informÃ¡ciÃ³k
            const fileInfoContainer = document.createElement("div");
            fileInfoContainer.className = "mb-3 flex-grow-1";

            if (isFilled) {
              const fileName = document.createElement("div");
              fileName.className = "text-center mb-2";
              fileName.style.cssText =
                "color: var(--accent-light); font-weight: 500; word-break: break-all;";
              const displayName =
                fileData.originalName.length > 25
                  ? fileData.originalName.substring(0, 25) + "..."
                  : fileData.originalName;
              fileName.textContent = displayName;
              fileName.title = fileData.originalName;

              const fileExt = document.createElement("div");
              fileExt.className = "text-center mb-1";
              fileExt.style.cssText = "color: var(--muted); font-size: 0.9rem;";
              const ext = fileData.originalName.split(".").pop().toUpperCase();
              fileExt.textContent = `.${ext}`;

              const fileSize = document.createElement("div");
              fileSize.className = "text-center";
              fileSize.style.cssText =
                "color: var(--muted); font-size: 0.85rem;";
              const sizeInBytes = fileData.metadata?.size || 0;
              fileSize.textContent = formatFileSize(sizeInBytes);

              const fileDate = document.createElement("div");
              fileDate.className = "text-center mt-1";
              fileDate.style.cssText = "color: #666; font-size: 0.8rem;";
              const uploadDate = fileData.created_at
                ? new Date(fileData.created_at)
                : new Date();
              fileDate.textContent = uploadDate.toLocaleDateString("hu-HU");

              fileInfoContainer.appendChild(fileName);
              fileInfoContainer.appendChild(fileExt);
              fileInfoContainer.appendChild(fileSize);
              fileInfoContainer.appendChild(fileDate);
            } else {
              const emptyText = document.createElement("div");
              emptyText.className = "text-center";
              emptyText.style.cssText =
                "color: var(--muted); font-style: italic; padding: 20px 0;";
              emptyText.textContent = "Ãœres slot";
              fileInfoContainer.appendChild(emptyText);
            }

            // KattinthatÃ³ kÃ¡rtya - Info modal megnyitÃ¡sa
            if (isFilled) {
              card.style.cursor = "pointer";
              card.onclick = (e) => {
                // Ne nyissa meg, ha Ã©pp gombot nyomunk
                if (e.target.tagName === 'BUTTON') return;
                openFileInfoModal(i, fileData, isImage);
              };
              
              // Hover effekt
              card.onmouseenter = () => {
                card.style.transform = "translateY(-5px)";
                card.style.boxShadow = "0 8px 25px rgba(127, 90, 240, 0.4)";
              };
              card.onmouseleave = () => {
                card.style.transform = "translateY(0)";
                card.style.boxShadow = "0 4px 15px rgba(127, 90, 240, 0.2)";
              };
            }

            // Gombok
            const buttonContainer = document.createElement("div");
            buttonContainer.className = "d-grid gap-2";

            // Ãœres slot - FeltÃ¶ltÃ©s gomb (csak bejelentkezve)
            if (!isFilled && canEdit) {
              const uploadBtn = document.createElement("button");
              uploadBtn.className = "btn";
              uploadBtn.style.cssText = `
                background: var(--accent);
                color: white;
                border: none;
                font-weight: 500;
              `;
              uploadBtn.innerHTML = 'FeltÃ¶ltÃ©s';
              uploadBtn.onclick = (e) => {
                e.stopPropagation();
                openUploadModal(i);
              };
              buttonContainer.appendChild(uploadBtn);
            } else if (!isFilled) {
              // Ha nincs bejelentkezve, info szÃ¶veg
              const infoText = document.createElement("div");
              infoText.className = "text-center";
              infoText.style.cssText = "color: var(--muted); font-size: 0.85rem; padding: 10px;";
              infoText.textContent = "Jelentkezz be a feltÃ¶ltÃ©shez";
              buttonContainer.appendChild(infoText);
            }

            // TÃ¶rÃ¶ltÃ¼k a rÃ©gi gombokat - most kattintÃ¡ssal nyÃ­lik a modal
            if (isFilled) {
              // EgyszerÅ± info szÃ¶veg hogy kattintÃ¡ssal megnyÃ­lik a rÃ©szletes nÃ©zet
              const clickInfo = document.createElement("div");
              clickInfo.className = "text-center mt-2";
              clickInfo.style.cssText = "color: var(--accent-light); font-size: 0.85rem; font-style: italic;";
              clickInfo.innerHTML = "Kattints a rÃ©szletekÃ©rt";
              buttonContainer.appendChild(clickInfo);
            }

            // Gombok betÃ¶ltÃ¶tt slotoknÃ¡l
            if (isFilled) {
              const buttonColumn = document.createElement("div");
              buttonColumn.className = "d-flex flex-column gap-2 mt-2";
              buttonColumn.style.cssText = "width: 100%;";

              // LetÃ¶ltÃ©s gomb (mindig lÃ¡thatÃ³ ha van fÃ¡jl)
              const downloadBtn = document.createElement("button");
              downloadBtn.className = "btn w-100";
              downloadBtn.style.cssText = `
                background: var(--accent);
                color: white;
                border: none;
                font-weight: 500;
              `;
              downloadBtn.textContent = "LetÃ¶ltÃ©s";
              downloadBtn.onclick = (e) => {
                e.stopPropagation();
                window.open(fileData.downloadUrl, '_blank');
              };
              buttonColumn.appendChild(downloadBtn);

              // Csere gomb (csak bejelentkezve)
              if (canEdit) {
                const replaceBtn = document.createElement("button");
                replaceBtn.className = "btn w-100";
                replaceBtn.style.cssText = `
                  background: transparent;
                  color: var(--muted);
                  border: 1px solid var(--muted);
                  font-weight: 500;
                `;
                replaceBtn.textContent = "Csere";
                replaceBtn.onclick = (e) => {
                  e.stopPropagation();
                  openUploadModal(i, fileData.originalName);
                };
                buttonColumn.appendChild(replaceBtn);
              }

              buttonContainer.appendChild(buttonColumn);
            }

            // Ã–sszeÃ¡llÃ­tÃ¡s
            cardBody.appendChild(iconContainer);
            cardBody.appendChild(slotTitle);
            cardBody.appendChild(fileInfoContainer);
            if (buttonContainer.children.length > 0) {
              cardBody.appendChild(buttonContainer);
            }

            card.appendChild(cardBody);
            col.appendChild(card);
            slotContainer.appendChild(col);
          }

          if (!silent) {
            const filledSlots = Object.keys(slotMappings).length;
            const usedMB = (totalStorageUsed / (1024 * 1024)).toFixed(2);
            const totalMB = (MAX_STORAGE_BYTES / (1024 * 1024)).toFixed(0);
            setFilesStatus(
              "success",
              `${filledSlots} slot â€¢ ${usedMB}/${totalMB} MB hasznÃ¡lva`
            );

            // 3 mÃ¡sodperc mÃºlva visszaÃ¡llÃ­tjuk az alapÃ¡llapotba
            setTimeout(() => {
              setFilesStatus("success", "");
            }, 3000);
          }
        } catch (err) {
          console.error("Slot frissÃ­tÃ©si hiba:", err);
          if (!silent) {
            setFilesStatus("error", "Hiba a slotok frissÃ­tÃ©sekor");
          }
        }
      }

      // FeltÃ¶ltÃ©s modal megnyitÃ¡sa
      function openUploadModal(slotNumber, existingFileName = null) {
        currentSlot = slotNumber;
        modalSlotTitle.textContent = `Slot ${slotNumber}`;
        fileUploadInput.value = "";
        fileInfo.style.display = "none";
        uploadProgress.style.display = "none";
        uploadProgressBar.style.width = "0%";
        uploadProgressBar.style.background = "var(--accent)";
        uploadProgressText.textContent = "FeltÃ¶ltÃ©s...";
        uploadProgressText.style.color = "var(--muted)";
        
        // Drop zone reset
        const dropZone = document.getElementById('dropZone');
        const dropZoneContent = document.getElementById('dropZoneContent');
        if (dropZone && dropZoneContent) {
          dropZone.style.borderColor = 'var(--accent)';
          dropZone.style.background = 'rgba(127, 90, 240, 0.05)';
          dropZoneContent.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“</div>
            <div style="color: var(--text); font-weight: 500; margin-bottom: 8px;">
              Kattints vagy hÃºzd ide a fÃ¡jlt
            </div>
            <div style="color: var(--muted); font-size: 0.9rem;">
              MaximÃ¡lis fÃ¡jlmÃ©ret: 50 MB
            </div>
          `;
        }

        // TÃ¡rhelyhasznÃ¡lat frissÃ­tÃ©se
        updateStorageDisplay();

        // Ha van meglÃ©vÅ‘ fÃ¡jl, tÃ¡jÃ©koztatjuk a felhasznÃ¡lÃ³t
        if (existingFileName) {
          selectedFileName.textContent = `A meglÃ©vÅ‘ fÃ¡jl (${existingFileName}) felÃ¼l lesz Ã­rva.`;
          selectedFileSize.textContent = "";
          fileInfo.style.display = "block";
        }

        uploadModal.show();
      }

      // FÃ¡jl info modal megnyitÃ¡sa
      function openFileInfoModal(slotNumber, fileData, isImage) {
        currentFileInfoSlot = slotNumber;
        
        // Modal cÃ­m
        document.getElementById('infoModalSlotTitle').textContent = `Slot ${slotNumber}`;
        
        // FÃ¡jl informÃ¡ciÃ³k
        document.getElementById('infoFileName').textContent = fileData.originalName;
        const sizeInBytes = fileData.metadata?.size || 0;
        document.getElementById('infoFileSize').textContent = formatFileSize(sizeInBytes);
        const uploadDate = fileData.created_at ? new Date(fileData.created_at) : new Date();
        document.getElementById('infoFileDate').textContent = uploadDate.toLocaleString('hu-HU');
        
        // ElÅ‘nÃ©zet kezelÃ©se
        const previewSection = document.getElementById('filePreviewSection');
        const previewImage = document.getElementById('filePreviewImage');
        const iconSection = document.getElementById('fileIconSection');
        const iconLarge = document.getElementById('fileIconLarge');
        
        if (isImage) {
          previewSection.style.display = 'block';
          previewImage.style.display = 'block';
          iconSection.style.display = 'none';
          // KÃ©p URL lekÃ©rÃ©se
          const { data: publicUrlData } = supabase.storage
            .from(BUCKET_NAME)
            .getPublicUrl(fileData.fileName);
          previewImage.src = publicUrlData.publicUrl;
          previewImage.alt = fileData.originalName;
        } else {
          previewSection.style.display = 'none';
          previewImage.style.display = 'none';
          iconSection.style.display = 'block';
          iconLarge.textContent = getFileIcon(fileData.originalName);
        }
        
        // Link generÃ¡lÃ³ rÃ©sz elrejtÃ©se alapbÃ³l
        const generatedLinkSection = document.getElementById('generatedLinkSection');
        generatedLinkSection.style.display = 'none';
        
        // Download gomb esemÃ©nykezelÅ‘
        const downloadBtn = document.getElementById('infoDownloadBtn');
        downloadBtn.onclick = () => {
          downloadFile(fileData.fileName, fileData.originalName);
        };
        
        // Delete gomb esemÃ©nykezelÅ‘ - csak szerkesztÃ©si joggal
        const deleteBtn = document.getElementById('infoDeleteBtn');
        if (canEdit) {
          deleteBtn.style.display = 'inline-block';
          deleteBtn.onclick = () => {
            fileInfoModal.hide();
            // TÃ¶rlÃ©s modal megnyitÃ¡sa
            fileToDelete = fileData.fileName;
            currentSlot = slotNumber;
            document.getElementById('deleteFileName').textContent = fileData.originalName;
            deleteModal.show();
          };
        } else {
          deleteBtn.style.display = 'none';
        }
        
        // Link generÃ¡lÃ¡s gomb esemÃ©nykezelÅ‘
        const generateLinkBtn = document.getElementById('generateLinkBtn');
        let currentDirectUrl = ''; // VÃ¡ltozÃ³ a direkt URL tÃ¡rolÃ¡sÃ¡ra
        generateLinkBtn.onclick = async () => {
          const expirySelect = document.getElementById('linkExpirySelect');
          const expirySeconds = parseInt(expirySelect.value);
          
          // Expiry szÃ¶veg generÃ¡lÃ¡sa
          let expiryText = '';
          switch(expirySeconds) {
            case 3600: expiryText = '1 Ã³ra'; break;
            case 21600: expiryText = '6 Ã³ra'; break;
            case 86400: expiryText = '24 Ã³ra'; break;
            case 259200: expiryText = '3 nap'; break;
            case 604800: expiryText = '7 nap'; break;
            default: expiryText = `${Math.floor(expirySeconds / 3600)} Ã³ra`;
          }
          
          generateLinkBtn.disabled = true;
          generateLinkBtn.textContent = 'GenerÃ¡lÃ¡s...';
          
          try {
            const linkData = await getDownloadLink(fileData.fileName, fileData.originalName, expirySeconds, slotNumber);
            currentDirectUrl = linkData.url;
            
            // Link megjelenÃ­tÃ©se
            document.getElementById('generatedLinkDisplay').textContent = linkData.customLink;
            document.getElementById('linkExpiryText').textContent = linkData.expiryText;
            generatedLinkSection.style.display = 'block';
            
            // Automatikus mÃ¡solÃ¡s a vÃ¡gÃ³lapra - EGYEDI CUSTOM LINK
            try {
              await navigator.clipboard.writeText(linkData.customLink);
              generateLinkBtn.textContent = 'âœ“ Link mÃ¡solva vÃ¡gÃ³lapra!';
              generateLinkBtn.style.background = 'var(--success)';
            } catch (clipboardErr) {
              console.error('VÃ¡gÃ³lapra mÃ¡solÃ¡s hiba:', clipboardErr);
              generateLinkBtn.textContent = 'âœ“ Link generÃ¡lva (mÃ¡solÃ¡s manuÃ¡lisan)';
            }
            
            setTimeout(() => {
              generateLinkBtn.textContent = 'ğŸ”— Link generÃ¡lÃ¡sa';
              generateLinkBtn.style.background = 'var(--accent)';
              generateLinkBtn.disabled = false;
            }, 3000);
          } catch (err) {
            console.error('Link generÃ¡lÃ¡si hiba:', err);
            console.error('Teljes hiba:', err.message, err);
            alert('Hiba a link generÃ¡lÃ¡sa sorÃ¡n: ' + (err.message || 'Ismeretlen hiba. EllenÅ‘rizd a konzolt (F12).'));
            generateLinkBtn.textContent = 'ğŸ”— Link generÃ¡lÃ¡sa';
            generateLinkBtn.disabled = false;
          }
        };
        
        // Modal megnyitÃ¡sa
        fileInfoModal.show();
      }

      // FÃ¡jl megjelenÃ­tÃ©se a drop zone-ban
      function displaySelectedFile(file) {
        const dropZone = document.getElementById('dropZone');
        const dropZoneContent = document.getElementById('dropZoneContent');
        
        if (!file) {
          fileInfo.style.display = "none";
          return;
        }

        // EllenÅ‘rizzÃ¼k a fÃ¡jlmÃ©retet
        if (file.size > MAX_FILE_SIZE_BYTES) {
          alert(
            `A fÃ¡jl tÃºl nagy! Maximum ${
              MAX_FILE_SIZE_BYTES / (1024 * 1024)
            } MB lehet.`
          );
          fileUploadInput.value = "";
          return;
        }

        // EllenÅ‘rizzÃ¼k, hogy van-e elÃ©g hely
        const existingFileSize = slotMappings[currentSlot] ? slotMappings[currentSlot].metadata.size : 0;
        const newStorageUsed = totalStorageUsed - existingFileSize + file.size;
        
        if (newStorageUsed > MAX_STORAGE_BYTES) {
          const needMB = ((newStorageUsed - MAX_STORAGE_BYTES) / (1024 * 1024)).toFixed(2);
          alert(`Nincs elÃ©g hely! SzÃ¼ksÃ©ges tovÃ¡bbi ${needMB} MB. TÃ¶rÃ¶lj nÃ©hÃ¡ny fÃ¡jlt.`);
          fileUploadInput.value = "";
          return;
        }

        // Drop zone tartalmÃ¡nak frissÃ­tÃ©se
        const fileIcon = getFileIcon(file.name);
        const isImage = /\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(file.name);
        
        if (isImage) {
          // KÃ©p elÅ‘nÃ©zet a drop zone-ban
          const reader = new FileReader();
          reader.onload = function(e) {
            dropZoneContent.innerHTML = `
              <div style="margin-bottom: 10px;">
                <img src="${e.target.result}" alt="Preview" style="
                  max-width: 100%;
                  max-height: 200px;
                  border-radius: 8px;
                  object-fit: contain;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                "/>
              </div>
              <div style="color: var(--accent-light); font-weight: 500; margin-bottom: 4px; word-break: break-all;">
                ${file.name}
              </div>
              <div style="color: var(--muted); font-size: 0.9rem;">
                ${formatFileSize(file.size)}
              </div>
            `;
          };
          reader.readAsDataURL(file);
        } else {
          // NormÃ¡l fÃ¡jl ikon
          dropZoneContent.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 10px;">${fileIcon}</div>
            <div style="color: var(--accent-light); font-weight: 500; margin-bottom: 4px; word-break: break-all;">
              ${file.name}
            </div>
            <div style="color: var(--muted); font-size: 0.9rem;">
              ${formatFileSize(file.size)}
            </div>
          `;
        }
        
        dropZone.style.borderColor = 'var(--success)';
        dropZone.style.background = 'rgba(127, 90, 240, 0.15)';

        // MegjelenÃ­tjÃ¼k a fÃ¡jl informÃ¡ciÃ³t
        selectedFileName.textContent = file.name;
        selectedFileSize.textContent = `MÃ©ret: ${formatFileSize(file.size)}`;
        fileInfo.style.display = "block";
      }

      // FÃ¡jl kivÃ¡lasztÃ¡s esemÃ©nykezelÅ‘
      fileUploadInput.addEventListener("change", function () {
        const file = this.files[0];
        displaySelectedFile(file);
      });

      // Drag & Drop esemÃ©nyek
      document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('dropZone');
        
        if (dropZone) {
          // KattintÃ¡s a drop zone-ra
          dropZone.addEventListener('click', () => {
            fileUploadInput.click();
          });

          // Prevent default drag behaviors
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
          });

          // Highlight drop zone when dragging over
          ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
              dropZone.style.borderColor = 'var(--accent-light)';
              dropZone.style.background = 'rgba(127, 90, 240, 0.2)';
              dropZone.style.transform = 'scale(1.02)';
            });
          });

          ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
              dropZone.style.borderColor = 'var(--accent)';
              dropZone.style.background = 'rgba(127, 90, 240, 0.05)';
              dropZone.style.transform = 'scale(1)';
            });
          });

          // Handle dropped files
          dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              // Csak az elsÅ‘ fÃ¡jlt hasznÃ¡ljuk
              const file = files[0];
              
              // ManuÃ¡lisan beÃ¡llÃ­tjuk a file input-ot
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(file);
              fileUploadInput.files = dataTransfer.files;
              
              displaySelectedFile(file);
            }
          });
        }
      });

      // FÃ¡jl feltÃ¶ltÃ©s
      confirmUpload.addEventListener("click", async function () {
        const file = fileUploadInput.files[0];
        if (!file) {
          alert("VÃ¡lassz ki egy fÃ¡jlt!");
          return;
        }

        // EllenÅ‘rizzÃ¼k a fÃ¡jlmÃ©retet
        if (file.size > MAX_FILE_SIZE_BYTES) {
          alert(
            `A fÃ¡jl tÃºl nagy! Maximum ${
              MAX_FILE_SIZE_BYTES / (1024 * 1024)
            } MB lehet.`
          );
          return;
        }

        // EllenÅ‘rizzÃ¼k a tÃ¡rhelyet
        const existingFileSize = slotMappings[currentSlot] ? slotMappings[currentSlot].metadata.size : 0;
        const newStorageUsed = totalStorageUsed - existingFileSize + file.size;
        
        if (newStorageUsed > MAX_STORAGE_BYTES) {
          const needMB = ((newStorageUsed - MAX_STORAGE_BYTES) / (1024 * 1024)).toFixed(2);
          alert(`Nincs elÃ©g hely! SzÃ¼ksÃ©ges tovÃ¡bbi ${needMB} MB. TÃ¶rÃ¶lj nÃ©hÃ¡ny fÃ¡jlt.`);
          return;
        }

        // FeltÃ¶ltÃ©s indÃ­tÃ¡sa - RESET progress bar
        uploadProgress.style.display = "block";
        uploadProgressBar.style.width = "30%";
        uploadProgressBar.style.background = "var(--accent)"; // Reset color
        uploadProgressText.textContent = "FeltÃ¶ltÃ©s...";
        uploadProgressText.style.color = "var(--muted)";
        this.disabled = true;

        try {
          // FÃ¡jlnÃ©v tisztÃ­tÃ¡sa: biztonsÃ¡gos karakterek megtartÃ¡sa
          // MegengedjÃ¼k: betÅ±k, szÃ¡mok, pont, kÃ¶tÅ‘jel, alÃ¡vonÃ¡s
          // SzÃ³kÃ¶zÃ¶ket Ã©s speciÃ¡lis karaktereket lecserÃ©ljÃ¼k
          const safeName = file.name
            .replace(/\s+/g, '_')  // SzÃ³kÃ¶zÃ¶k -> alÃ¡hÃºzÃ¡s
            .replace(/[^\w\.-]/g, '_')  // SpeciÃ¡lis karakterek -> alÃ¡hÃºzÃ¡s
            .replace(/_+/g, '_');  // TÃ¶bbszÃ¶rÃ¶s alÃ¡hÃºzÃ¡s -> egyszeres
          
          // Egyedi fÃ¡jlnÃ©v generÃ¡lÃ¡sa: slot{slotNumber}_{tisztÃ­tottFÃ¡jlnÃ©v}
          const slotFileName = `slot${currentSlot}_${safeName}`;

          // EllenÅ‘rizzÃ¼k, hogy van-e mÃ¡r fÃ¡jl ebben a slotban
          const existingFileData = slotMappings[currentSlot];

          uploadProgressBar.style.width = "60%";

          // Ha van meglÃ©vÅ‘ fÃ¡jl ebben a slotban, tÃ¶rÃ¶ljÃ¼k
          if (existingFileData && existingFileData.fileName) {
            await supabase.storage
              .from(BUCKET_NAME)
              .remove([existingFileData.fileName]);
          }

          // FeltÃ¶ltÃ©s
          const { data, error } = await supabase.storage
            .from(BUCKET_NAME)
            .upload(slotFileName, file, {
              cacheControl: "3600",
              upsert: true,
            });

          uploadProgressBar.style.width = "90%";

          if (error) {
            console.error("FeltÃ¶ltÃ©si hiba:", error);
            uploadProgressText.textContent = "Hiba a feltÃ¶ltÃ©s sorÃ¡n";
            uploadProgressText.style.color = "var(--error)";
            uploadProgressBar.style.background = "var(--error)";
            throw error;
          }

          // Sikeres feltÃ¶ltÃ©s
          uploadProgressText.textContent = "FeltÃ¶ltÃ©s sikeres!";
          uploadProgressText.style.color = "var(--success)";
          uploadProgressBar.style.width = "100%";
          uploadProgressBar.style.background = "var(--success)";

          setTimeout(() => {
            uploadModal.hide();
            updateSlots();
            this.disabled = false;
            fileUploadInput.value = "";
            // Reset progress bar state
            uploadProgress.style.display = "none";
            uploadProgressBar.style.width = "0%";
            uploadProgressBar.style.background = "var(--accent)";
            uploadProgressText.textContent = "FeltÃ¶ltÃ©s...";
            uploadProgressText.style.color = "var(--muted)";
          }, 1000);
        } catch (err) {
          console.error("FeltÃ¶ltÃ©si hiba:", err);
          alert("FeltÃ¶ltÃ©s sikertelen: " + (err.message || "Ismeretlen hiba"));
          this.disabled = false;
          
          // Reset progress bar after error
          setTimeout(() => {
            uploadProgress.style.display = "none";
            uploadProgressBar.style.width = "0%";
            uploadProgressBar.style.background = "var(--accent)";
            uploadProgressText.textContent = "FeltÃ¶ltÃ©s...";
            uploadProgressText.style.color = "var(--muted)";
          }, 2000);
        }
      });

      // FÃ¡jl tÃ¶rlÃ©se Ã©s Ã¡trendezÃ©s
      confirmDelete.addEventListener("click", async function () {
        if (!fileToDelete) return;

        try {
          // TÃ¶rÃ¶ljÃ¼k a fÃ¡jlt
          const { error } = await supabase.storage
            .from(BUCKET_NAME)
            .remove([fileToDelete]);

          if (error) {
            console.error("TÃ¶rlÃ©si hiba:", error);
            alert("Hiba a tÃ¶rlÃ©s sorÃ¡n: " + error.message);
            return;
          }

          // ÃtrendezzÃ¼k a fÃ¡jlokat
          await reorderSlots(currentSlot);
          
          // FrissÃ­tjÃ¼k a megjelenÃ­tÃ©st
          updateSlots();
        } catch (err) {
          console.error("TÃ¶rlÃ©si hiba:", err);
          alert("Hiba a tÃ¶rlÃ©s sorÃ¡n");
        } finally {
          deleteModal.hide();
          fileToDelete = null;
          currentSlot = null;
        }
      });

      // Slot Ã¡trendezÃ©s funkciÃ³
      async function reorderSlots(deletedSlotNum) {
        try {
          // LekÃ©rjÃ¼k az Ã¶sszes fÃ¡jlt
          const { data: allFiles, error: listError } = await supabase.storage
            .from(BUCKET_NAME)
            .list("");

          if (listError) {
            console.error("FÃ¡jllista lekÃ©rÃ©si hiba:", listError);
            return;
          }

          // RendezzÃ¼k slot szÃ¡m szerint
          const filesBySlot = {};
          allFiles.forEach((file) => {
            const match = file.name.match(/slot(\d+)_(.+)/);
            if (match) {
              const slotNum = parseInt(match[1]);
              filesBySlot[slotNum] = {
                fileName: file.name,
                originalName: match[2]
              };
            }
          });

          // MegkeressÃ¼k a tÃ¶rÃ¶lt slot utÃ¡ni slotokat Ã©s Ã¡tnevezzÃ¼k Å‘ket
          const slotNumbers = Object.keys(filesBySlot).map(n => parseInt(n)).sort((a, b) => a - b);
          
          for (let i = 0; i < slotNumbers.length; i++) {
            const currentSlotNum = slotNumbers[i];
            
            // Ha a slot nagyobb mint a tÃ¶rÃ¶lt slot, eggyel csÃ¶kkentjÃ¼k
            if (currentSlotNum > deletedSlotNum) {
              const newSlotNum = currentSlotNum - 1;
              const fileData = filesBySlot[currentSlotNum];
              const oldFileName = fileData.fileName;
              const newFileName = `slot${newSlotNum}_${fileData.originalName}`;

              // LetÃ¶ltjÃ¼k a fÃ¡jlt
              const { data: fileBlob, error: downloadError } = await supabase.storage
                .from(BUCKET_NAME)
                .download(oldFileName);

              if (downloadError) {
                console.error("FÃ¡jl letÃ¶ltÃ©si hiba Ã¡tnevezÃ©skor:", downloadError);
                continue;
              }

              // FeltÃ¶ltjÃ¼k az Ãºj nÃ©vvel
              const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(newFileName, fileBlob, {
                  cacheControl: "3600",
                  upsert: true
                });

              if (uploadError) {
                console.error("FÃ¡jl feltÃ¶ltÃ©si hiba Ã¡tnevezÃ©skor:", uploadError);
                continue;
              }

              // TÃ¶rÃ¶ljÃ¼k a rÃ©git
              await supabase.storage
                .from(BUCKET_NAME)
                .remove([oldFileName]);
            }
          }
        } catch (err) {
          console.error("ÃtrendezÃ©si hiba:", err);
        }
      }

      // BEJELENTKEZÃ‰SI FUNKCIÃ“K

      // Site-wide bejelentkezÃ©s
      function setSitewideLoginState() {
        try {
          const expiry = Date.now() + SITEWIDE_LOGIN_DURATION;
          localStorage.setItem(SITEWIDE_LOGIN_KEY, "logged_in");
          localStorage.setItem(SITEWIDE_LOGIN_EXPIRY, expiry.toString());

          if (window.setLoginState) {
            window.setLoginState();
          }
        } catch (e) {
          console.error(
            "Site-wide bejelentkezÃ©si Ã¡llapot mentÃ©se sikertelen:",
            e
          );
        }
      }

      function checkSitewideLogin() {
        try {
          const loginState = localStorage.getItem(SITEWIDE_LOGIN_KEY);
          const loginExpiry = localStorage.getItem(SITEWIDE_LOGIN_EXPIRY);

          if (!loginState || !loginExpiry) return false;

          const now = Date.now();
          if (now > parseInt(loginExpiry)) {
            localStorage.removeItem(SITEWIDE_LOGIN_KEY);
            localStorage.removeItem(SITEWIDE_LOGIN_EXPIRY);
            return false;
          }

          return loginState === "logged_in";
        } catch (e) {
          return false;
        }
      }

      function clearSitewideLogin() {
        try {
          localStorage.removeItem(SITEWIDE_LOGIN_KEY);
          localStorage.removeItem(SITEWIDE_LOGIN_EXPIRY);

          if (window.logoutFromNav) {
            window.logoutFromNav();
          }
        } catch (e) {
          console.error("Site-wide bejelentkezÃ©s tÃ¶rlÃ©se sikertelen:", e);
        }
      }

      // Remember me token kezelÃ©se
      function setRememberToken() {
        const token = {
          value: PASSWORD_HASH,
          expires: Date.now() + REMEMBER_DURATION,
        };
        localStorage.setItem(REMEMBER_ME_KEY, JSON.stringify(token));
      }

      function checkRememberMe() {
        const stored = localStorage.getItem(REMEMBER_ME_KEY);
        if (!stored) return false;
        try {
          const token = JSON.parse(stored);
          if (token.value === PASSWORD_HASH && token.expires > Date.now()) {
            return true;
          }
        } catch (e) {
          console.error("HibÃ¡s remember token:", e);
        }
        localStorage.removeItem(REMEMBER_ME_KEY);
        return false;
      }

      // SHA-256 hash fÃ¼ggvÃ©ny
      async function sha256hex(str) {
        const enc = new TextEncoder().encode(str);
        const digest = await crypto.subtle.digest("SHA-256", enc);
        return Array.from(new Uint8Array(digest))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      // ESEMÃ‰NYKEZELÅK BEÃLLÃTÃSA

      document.addEventListener("DOMContentLoaded", () => {
        // AlapÃ©rtelmezett beÃ¡llÃ­tÃ¡sok
        pwModal.style.display = "none";
        pwModal.setAttribute("aria-hidden", "true");
        ta.readOnly = true;
        saveBtn.disabled = true;

        // EllenÅ‘rizzÃ¼k a remember me Ã©s site-wide bejelentkezÃ©st
        if (checkRememberMe() || checkSitewideLogin()) {
          canEdit = true;
          ta.readOnly = false;
          saveBtn.disabled = false;
          mainBtns.style.display = "none";
          authBtns.style.display = "flex";
        }

        // Slotok betÃ¶ltÃ©se
        updateSlots();

        // URL paramÃ©ter ellenÅ‘rzÃ©se - ha valaki egyedi linken keresztÃ¼l Ã©rkezett
        const urlParams = new URLSearchParams(window.location.search);
        const fileCode = urlParams.get('file');
        if (fileCode) {
          // KinyerjÃ¼k a slot szÃ¡mot az egyedi kÃ³dbÃ³l (pl. S1-ABC123 -> 1)
          const slotMatch = fileCode.match(/^S(\d+)-/);
          if (slotMatch) {
            const targetSlot = parseInt(slotMatch[1]);
            // VÃ¡runk egy kicsit, hogy a slotok betÃ¶ltÅ‘djenek, majd AUTOMATIKUSAN LETÃ–LTJÃœK
            setTimeout(async () => {
              const fileData = slotMappings[targetSlot];
              if (fileData) {
                // Automatikus letÃ¶ltÃ©s indÃ­tÃ¡sa
                setFilesStatus('loading', `LetÃ¶ltÃ©s indul: ${fileData.originalName}...`);
                await downloadFile(fileData.fileName, fileData.originalName);
                // URL paramÃ©ter tÃ¶rlÃ©se a bÃ¶ngÃ©szÅ‘ cÃ­msorÃ¡bÃ³l
                window.history.replaceState({}, document.title, window.location.pathname);
              } else {
                setFilesStatus('error', `A fÃ¡jl nem talÃ¡lhatÃ³ (Slot ${targetSlot}). Lehet, hogy tÃ¶rÃ¶lve lett.`);
              }
            }, 1000);
          }
        }

        // Realtime elÅ‘fizetÃ©sek indÃ­tÃ¡sa
        subscribeFileRealtime();
        
        // TÃ¡rhelyhasznÃ¡lat frissÃ­tÃ©se a fÅ‘oldalon
        setInterval(() => {
          const totalStorageDisplay = document.getElementById('totalStorageDisplay');
          const totalStorageBar = document.getElementById('totalStorageBar');
          
          if (totalStorageDisplay && totalStorageBar) {
            const usedMB = (totalStorageUsed / (1024 * 1024)).toFixed(2);
            const totalMB = (MAX_STORAGE_BYTES / (1024 * 1024)).toFixed(0);
            const percentage = (totalStorageUsed / MAX_STORAGE_BYTES) * 100;
            
            totalStorageDisplay.textContent = `${usedMB} MB / ${totalMB} MB`;
            totalStorageBar.style.width = `${percentage}%`;
            
            if (percentage > 90) {
              totalStorageBar.style.background = 'var(--error)';
            } else if (percentage > 70) {
              totalStorageBar.style.background = 'orange';
            } else {
              totalStorageBar.style.background = 'linear-gradient(90deg, var(--accent), var(--accent-light))';
            }
          }
        }, 1000);

        // JelszÃ³ modal esemÃ©nyek
        openPw.addEventListener("click", () => {
          pwNote.style.display = "none";
          pwInfo.style.display = "none";
          pwModal.style.display = "flex";
          pwModal.setAttribute("aria-hidden", "false");
          pwInput.value = "";
          pwInput.type = "password";
          togglePassword.style.backgroundImage =
            'url("assets/images/view.webp")';
          setTimeout(() => pwInput.focus(), 50);
        });

        // Modal bezÃ¡rÃ¡s
        const closeModal = () => {
          pwModal.style.display = "none";
          pwModal.setAttribute("aria-hidden", "true");
          pwInput.value = "";
          pwNote.style.display = "none";
          pwInput.type = "password";
          togglePassword.style.backgroundImage =
            'url("assets/images/view.webp")';
          rememberMe.checked = false;
        };

        pwCancel.addEventListener("click", closeModal);

        // ESC billentyÅ±
        pwModal.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            e.preventDefault();
            closeModal();
          }
        });

        // FÃ³kusz kezelÃ©s
        pwModal.addEventListener("keydown", (e) => {
          if (e.key === "Tab") {
            const focusableElements = pwBox.querySelectorAll(
              'input, button, [tabindex="0"]'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[ocusableElements.length - 1];

            if (e.shiftKey) {
              if (document.activeElement === firstElement) {
                e.preventDefault();
                lastElement.focus();
              }
            } else {
              if (document.activeElement === lastElement) {
                e.preventDefault();
                firstElement.focus();
              }
            }
          }
        });

        pwModal.addEventListener("mousedown", (e) => {
          if (e.target === pwModal && e.button === 0) {
            e.preventDefault();
            pwCancel.click();
          }
        });

        pwInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            pwOk.click();
          }
        });

        pwOk.addEventListener("click", async () => {
          const raw = pwInput.value || "";
          const attempt = raw.trim();
          pwNote.style.display = "none";
          try {
            const h = await sha256hex(attempt);
            document.dispatchEvent(
              new CustomEvent("infosharer:pwAttempt", {
                detail: { hash: h, raw: attempt },
              })
            );
          } catch (err) {
            pwNote.textContent = "Hiba a jelszÃ³ellenÅ‘rzÃ©snÃ©l";
            pwNote.style.display = "block";
          }
        });

        // JelszÃ³ lÃ¡thatÃ³sÃ¡g vÃ¡ltÃ¡sa
        togglePassword.addEventListener("click", function () {
          const isPassword = pwInput.type === "password";
          pwInput.type = isPassword ? "text" : "password";
          this.style.backgroundImage = isPassword
            ? 'url("assets/images/hide.webp")'
            : 'url("assets/images/view.webp")';
        });

        // MentÃ©s gomb
        saveBtn.addEventListener("click", async () => {
          if (!canEdit) {
            alert("ElÅ‘bb engedÃ©lyezd az Ã­rÃ¡st jelszÃ³val.");
            return;
          }
          saveBtn.textContent = "MentÃ©s...";
          saveBtn.disabled = true;
          await upsert(ta.value);
          saveBtn.textContent = "Mentve";
          setTimeout(() => {
            saveBtn.textContent = "MentÃ©s";
            saveBtn.disabled = false;
          }, 900);
        });

        // MÃ¡solÃ¡s gombok
        const handleCopy = async (button) => {
          try {
            await navigator.clipboard.writeText(ta.value);
            const old = button.textContent;
            button.textContent = "MÃ¡solva";
            setTimeout(() => {
              button.textContent = old;
            }, 900);
          } catch (err) {
            alert("MÃ¡solÃ¡s sikertelen");
          }
        };

        copyBtn.addEventListener("click", () => handleCopy(copyBtn));
        copyBtn2.addEventListener("click", () => handleCopy(copyBtn2));

        // KijelentkezÃ©s
        logoutBtn.addEventListener("click", function () {
          localStorage.removeItem(REMEMBER_ME_KEY);
          clearSitewideLogin();

          canEdit = false;
          ta.readOnly = true;
          saveBtn.disabled = true;
          authBtns.style.display = "none";
          mainBtns.style.display = "flex";

          try {
            if (channelRef && typeof channelRef.unsubscribe === "function") {
              channelRef.unsubscribe();
            }
          } catch (e) {
            console.warn("unsubscribe error", e);
          }
          channelRef = null;
          setStatusFromState("Ã©lÅ‘");
          statusEl.textContent = "Kapcsolat: -";

          // Slotok frissÃ­tÃ©se (eltÅ±nik a feltÃ¶ltÃ©s/tÃ¶rlÃ©s gomb)
          updateSlots();
        });
      });

      // BejelentkezÃ©si esemÃ©nyek
      document.addEventListener("infosharer:pwAttempt", (ev) => {
        try {
          const sentHash = (ev?.detail?.hash || "").toLowerCase();
          if (
            !PASSWORD_HASH ||
            PASSWORD_HASH.length === 0 ||
            PASSWORD_HASH === "replace_with_sha256_hex_of_password"
          ) {
            document.dispatchEvent(
              new CustomEvent("infosharer:authFail", {
                detail: {
                  message:
                    "A szerver nincs konfigurÃ¡lva (PASSWORD_HASH hiÃ¡nyzik).",
                },
              })
            );
            return;
          }
          if (sentHash === PASSWORD_HASH.toLowerCase()) {
            document.dispatchEvent(new CustomEvent("infosharer:authSuccess"));
            canEdit = true;
            saveBtn.disabled = false;
            setTimeout(() => ta.focus(), 50);
          } else {
            document.dispatchEvent(
              new CustomEvent("infosharer:authFail", {
                detail: { message: "Helytelen jelszÃ³" },
              })
            );
          }
        } catch (err) {
          document.dispatchEvent(
            new CustomEvent("infosharer:authFail", {
              detail: { message: "Hiba" },
            })
          );
        }
      });

      document.addEventListener("infosharer:authSuccess", () => {
        pwModal.style.display = "none";
        pwModal.setAttribute("aria-hidden", "true");
        pwInput.value = "";
        pwNote.style.display = "none";
        pwInfo.style.display = "block";
        setTimeout(() => (pwInfo.style.display = "none"), 1200);
        ta.readOnly = false;
        mainBtns.style.display = "none";
        authBtns.style.display = "flex";

        // BejelentkezÃ©si Ã¡llapot beÃ¡llÃ­tÃ¡sa
        setSitewideLoginState();
        if (rememberMe.checked) {
          setRememberToken();
        }
        rememberMe.checked = false;

        // Slotok frissÃ­tÃ©se (megjelennek a feltÃ¶ltÃ©s/tÃ¶rlÃ©s gombok)
        updateSlots();
      });

      document.addEventListener("infosharer:authFail", (e) => {
        pwNote.textContent = e?.detail?.message || "Helytelen jelszÃ³";
        pwNote.style.display = "block";
      });

      // InicializÃ¡lÃ¡s
      (async function init() {
        await load();
        subscribeRealtime();
        const REFRESH_INTERVAL = 1000;
        setInterval(async () => {
          try {
            if (canEdit && document.activeElement === ta) return;
            await load();
            const t = new Date();
            const hh = t.getHours().toString().padStart(2, "0");
            const mm = t.getMinutes().toString().padStart(2, "0");
            const ss = t.getSeconds().toString().padStart(2, "0");
            const stamp = hh + ":" + mm + ":" + ss;
            const currentState = statusEl.dataset.state || "ismeretlen";
            statusEl.textContent = "Kapcsolat: frissÃ­tve " + stamp;
            if (currentState) {
              statusEl.dataset.state = currentState;
            }
          } catch (e) {
            console.error(e);
          }
        }, REFRESH_INTERVAL);
      })();
    </script>

    <!-- StÃ­lusok a slot kÃ¡rtyÃ¡khoz -->
    <style>
      .card {
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(127, 90, 240, 0.3) !important;
      }
      
      /* KÃ©p elÅ‘nÃ©zet animÃ¡ciÃ³k */
      .card img {
        transition: transform 0.3s ease;
      }
      
      .card:hover img {
        transform: scale(1.05);
      }

      .btn {
        transition: all 0.2s ease;
        border-radius: 8px;
        padding: 0.5rem 1rem;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .modal-content {
        border-radius: 12px;
      }

      .form-control {
        background: #16162a;
        color: var(--text);
        border: 1px solid var(--accent);
        border-radius: 8px;
        padding: 0.75rem;
      }

      .form-control:focus {
        background: #16162a;
        color: var(--text);
        border-color: var(--accent-light);
        box-shadow: 0 0 0 0.25rem rgba(127, 90, 240, 0.25);
      }

      .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .form-text {
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .col-md-3 {
          flex: 0 0 50%;
          max-width: 50%;
        }
      }

      @media (max-width: 576px) {
        .col-md-3,
        .col-sm-6 {
          flex: 0 0 100%;
          max-width: 100%;
        }

        .card-body {
          padding: 1.25rem;
        }
      }
    </style>

    <script src="assets/js/nav.js"></script>
    <script src="assets/js/footer.js"></script>
  </body>
</html>
