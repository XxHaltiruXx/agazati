<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infosharer — jelszóval védett írás (stabil)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:18px auto;padding:12px}
    textarea{width:100%;min-height:320px;padding:10px;font-size:16px;box-sizing:border-box;border-radius:6px}
    #pwModal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
    #pwBox{background:#fff;padding:20px;border-radius:8px;max-width:400px;width:90%}
    .hidden{display:none !important}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .meta{color:#555;margin-bottom:8px}
    #pwNote{color:#a00;display:none;margin-top:8px}
    .info{color:#060;display:none;margin-top:8px}
  </style>
</head>
<body>
  <h1>Infosharer — írás jelszóval</h1>
  <div class="meta">Az oldal alapból csak olvasható. Írni csak akkor tudsz, ha megadod a jelszót.</div>

  <textarea id="shared" readonly placeholder="Betöltés..."></textarea>
  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
    <button id="openPw">Írás engedélyezése (jelszó)</button>
    <button id="clearBtn">Törlés (őrzött)</button>
    <div style="margin-left:auto"><small id="status">Kapcsolat: -</small></div>
  </div>

  <!-- modal: rejtve inline style-szal (biztos) -->
  <div id="pwModal" class="hidden" role="dialog" aria-modal="true" aria-hidden="true" >
    <div id="pwBox" role="document">
      <h3>Írás jelszóval</h3>
      <p>Írd be a jelszót, hogy szerkeszthess.</p>
      <input id="pwInput" type="password" placeholder="Jelszó" style="width:100%;padding:8px;margin-bottom:8px" autocomplete="off" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="pwCancel" type="button">Mégse</button>
        <button id="pwOk" type="button">Megnyitás</button>
      </div>
      <p id="pwNote">Helytelen jelszó</p>
      <p id="pwInfo" class="info">Sikeres — írás engedélyezve</p>
    </div>
  </div>

  <!-- -------- Non-module script: UI + jelszó logika (nem törik meg import hibától) -------- -->
  <script>
    (function(){
      // Biztonsági: ne fusson még semmi, míg a DOM le nem töltődött
      document.addEventListener('DOMContentLoaded', () => {
        const pwModal = document.getElementById('pwModal');
        const pwInput = document.getElementById('pwInput');
        const pwOk = document.getElementById('pwOk');
        const pwCancel = document.getElementById('pwCancel');
        const openPw = document.getElementById('openPw');
        const pwNote = document.getElementById('pwNote');
        const pwInfo = document.getElementById('pwInfo');
        const ta = document.getElementById('shared');

        // Biztosan rejtve induljon
        pwModal.classList.add('hidden');
        pwModal.setAttribute('aria-hidden', 'true');
        ta.readOnly = true;

        async function sha256hex(str){
          const buf = new TextEncoder().encode(str);
          const raw = await crypto.subtle.digest('SHA-256', buf);
          return Array.from(new Uint8Array(raw)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        // Megnyitás gomb
        openPw.addEventListener('click', ()=> {
          pwNote.style.display = 'none';
          pwInfo.style.display = 'none';
          pwModal.classList.remove('hidden');
          pwModal.setAttribute('aria-hidden','false');
          pwInput.value = '';
          // fókusz késleltetve (mobilon jobb)
          setTimeout(()=> pwInput.focus(), 50);
        });

        // Mégse gomb: bezárja a modalt
        pwCancel.addEventListener('click', ()=> {
          pwModal.classList.add('hidden');
          pwModal.setAttribute('aria-hidden','true');
          pwNote.style.display = 'none';
          pwInput.value = '';
        });

        // katt a háttérre bezárás (ha a felhasználó a hátteret nyomja)
        pwModal.addEventListener('click', (e) => {
          if (e.target === pwModal) {
            pwCancel.click();
          }
        });

        // Enter lenyomás a mezőben
        pwInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); pwOk.click(); }
        });

        // A pwOk csak a jelszó hash-ért felelős — nem ismeri a PASSWORD_HASH-t,
        // ezért összehasonlítás helyett elküld egy "auth:attempt" eseményt az oldalnak
        // (a modul-szkript felül fogja hallgatni és eldönti a végleges egyezést).
        pwOk.addEventListener('click', async () => {
          const attemptRaw = pwInput.value || '';
          const attempt = attemptRaw.trim();
          pwNote.style.display = 'none';
          try {
            const h = await sha256hex(attempt);
            // Dispatcheljünk egy custom eventet a hash-szal — modul majd eldönti.
            // event detail: { hash: h, rawTrimmed: attempt }
            document.dispatchEvent(new CustomEvent('infosharer:pwAttempt', { detail: { hash: h, raw: attempt } }));
          } catch (err) {
            console.error('SHA error', err);
            pwNote.textContent = 'Hiba a jelszóellenőrzésnél';
            pwNote.style.display = 'block';
          }
        });

        // Ha az auth sikeres (a modul küldi az eseményt), le kell zárni a modalt és engedélyezni a szerkesztést
        document.addEventListener('infosharer:authSuccess', () => {
          pwModal.classList.add('hidden');
          pwModal.setAttribute('aria-hidden','true');
          pwInput.value = '';
          pwNote.style.display = 'none';
          pwInfo.style.display = 'block';
          setTimeout(()=> pwInfo.style.display = 'none', 1200);
          ta.readOnly = false;
          openPw.disabled = true;
          ta.focus();
          // értesítjük a modul szkriptet is, ha kell
          document.dispatchEvent(new CustomEvent('infosharer:editingEnabled'));
        });

        // Ha auth fail, mutatjuk a hibaüzenetet
        document.addEventListener('infosharer:authFail', (e) => {
          pwNote.textContent = e?.detail?.message || 'Helytelen jelszó';
          pwNote.style.display = 'block';
        });
      });
    })();
  </script>

  <!-- -------- Module script: Supabase + valódi hash ellenőrzés + realtime -------- -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ---------- CSERÉLD KI A SAJÁT ADATAIDRA ----------
    const SUPABASE_URL = 'https://ccpuoqrbmldunshaxpes.supabase.co'; // ← cseréld
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjcHVvcXJibWxkdW5zaGF4cGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE2MDUsImV4cCI6MjA3ODA4NzYwNX0.QpVCmzF96Fp5hdgFyR0VkT9RV6qKiLkA8Yv_LArSk5I';       // ← cseréld (teljes)
    const PASSWORD_HASH = '248e464b6e49676c615430dbfb831787d3d7c78e52bd2cb2461608991f7204f6'; // ← cseréld
    const TABLE = 'infosharer';
    const ID = 1;
    // -------------------------------------------------

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const ta = document.getElementById('shared');
    const status = document.getElementById('status');
    const clearBtn = document.getElementById('clearBtn');

    let canEdit = false;

    async function load(){
      try {
        const { data, error } = await supabase.from(TABLE).select('content').eq('id', ID).limit(1).single();
        if (!error && data) ta.value = data.content || '';
      } catch (err) {
        console.error('Supabase load error', err);
      }
    }

    function subscribeRealtime(){
      // ha a subscribe exception dob, logoljuk, de ne törjük el a jelszó UI-t
      try {
        supabase.channel('public:'+TABLE)
          .on('postgres_changes', { event: '*', schema: 'public', table: TABLE, filter: `id=eq.${ID}` },
            payload => {
              const row = payload?.new;
              if (row) {
                // egyszerű felülírás
                ta.value = row.content || '';
              }
            })
          .subscribe(statusObj => {
            status.textContent = 'Realtime: ' + (statusObj?.status || 'unknown');
          });
      } catch (err) {
        console.error('subscribeRealtime error', err);
        status.textContent = 'Realtime: hibás';
      }
    }

    async function upsert(text){
      try { await supabase.from(TABLE).upsert({ id: ID, content: text }, { onConflict: 'id' }); }
      catch(e){ console.error('Upsert hiba', e); }
    }

    function debounce(fn, wait=600){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    // Ha a korábbi (nem-module) UI script elküldte a hash-t, ide jön
    document.addEventListener('infosharer:pwAttempt', (ev) => {
      try {
        const sentHash = (ev?.detail?.hash || '').toLowerCase();
        // összehasonlítjuk a helyi PASSWORD_HASH-sal (ami csak a JS-ben van)
        if (sentHash === PASSWORD_HASH.toLowerCase()) {
          // siker: küldjünk siker eseményt a UI-nak
          document.dispatchEvent(new CustomEvent('infosharer:authSuccess'));
          canEdit = true;
        } else {
          document.dispatchEvent(new CustomEvent('infosharer:authFail', { detail: { message: 'Helytelen jelszó' } }));
        }
      } catch (err) {
        console.error('pwAttempt handling error', err);
        document.dispatchEvent(new CustomEvent('infosharer:authFail', { detail: { message: 'Hiba' } }));
      }
    });

    // Ha a UI engedélyezi az írást, a dokument egy eseményt küld - figyeljük
    document.addEventListener('infosharer:editingEnabled', () => { canEdit = true; });

    // input -> upsert, csak ha canEdit
    const send = debounce(()=> { if (!canEdit) return; upsert(ta.value); }, 600);
    ta.addEventListener('input', ()=> send());
    clearBtn.addEventListener('click', ()=> {
      if (!canEdit){ alert('Előbb engedélyezd az írást jelszóval.'); return; }
      if (!confirm('Biztosan törlöd a tartalmat?')) return;
      ta.value = '';
      upsert('');
    });

    // init
    (async ()=>{ await load(); subscribeRealtime(); })();

  </script>
</body>
</html>