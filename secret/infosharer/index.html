<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infosharer — jelszóval védett írás</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:18px auto;padding:12px}
    textarea{width:100%;min-height:320px;padding:10px;font-size:16px;box-sizing:border-box;border-radius:6px}
    #pwModal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
    #pwBox{background:#fff;padding:20px;border-radius:8px;max-width:400px;width:90%}
    .hidden{display:none}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .meta{color:#555;margin-bottom:8px}
    #pwNote{color:#a00;display:none;margin-top:8px}
    .info{color:#060;display:none;margin-top:8px}
  </style>
</head>
<body>
  <h1>Infosharer — írás jelszóval</h1>
  <div class="meta">Az oldal alapból csak olvasható. Írni csak akkor tudsz, ha megadod a jelszót.</div>

  <textarea id="shared" readonly placeholder="Betöltés..."></textarea>
  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
    <button id="openPw">Írás engedélyezése (jelszó)</button>
    <button id="clearBtn">Törlés (őrzött)</button>
    <div style="margin-left:auto"><small id="status">Kapcsolat: -</small></div>
  </div>

  <div id="pwModal" class="hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="pwBox" role="document">
      <h3>Írás jelszóval</h3>
      <p>Írd be a jelszót, hogy szerkeszthess.</p>
      <input id="pwInput" type="password" placeholder="Jelszó" style="width:100%;padding:8px;margin-bottom:8px" autocomplete="off" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="pwCancel">Mégse</button>
        <button id="pwOk">Megnyitás</button>
      </div>
      <p id="pwNote">Helytelen jelszó</p>
      <p id="pwInfo" class="info">Sikeres - írás engedélyezve</p>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ---------- CSERÉLD KI A SAJÁT ADATAIDRA ----------
    const SUPABASE_URL = 'https://ccpuoqrbmldunshaxpes.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjcHVvcXJibWxkdW5zaGF4cGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE2MDUsImV4cCI6MjA3ODA4NzYwNX0.QpVCmzF96Fp5hdgFyR0VkT9RV6qKiLkA8Yv_LArSk5I';
    const PASSWORD_HASH = '248e464b6e49676c615430dbfb831787d3d7c78e52bd2cb2461608991f7204f6';
    const TABLE = 'infosharer';
    const ID = 1;
    // -------------------------------------------------

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const ta = document.getElementById('shared');
    const status = document.getElementById('status');
    const openPw = document.getElementById('openPw');
    const pwModal = document.getElementById('pwModal');
    const pwBox = document.getElementById('pwBox');
    const pwInput = document.getElementById('pwInput');
    const pwOk = document.getElementById('pwOk');
    const pwCancel = document.getElementById('pwCancel');
    const pwNote = document.getElementById('pwNote');
    const pwInfo = document.getElementById('pwInfo');
    const clearBtn = document.getElementById('clearBtn');

    let canEdit = false;

    async function sha256hex(str){
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function load(){
      try{
        const { data, error } = await supabase
          .from(TABLE)
          .select('content')
          .eq('id', ID)
          .limit(1)
          .single();
        if (!error && data) ta.value = data.content || '';
        else if (error && error.code) console.warn('Supabase select hiba:', error);
      }catch(e){ console.error(e); }
    }

    function subscribeRealtime(){
      supabase.channel('public:'+TABLE)
        .on('postgres_changes', { event: '*', schema: 'public', table: TABLE, filter: `id=eq.${ID}` },
            payload => {
              const row = payload?.new;
              if (row) {
                // egyszerű felülírás; ha gépelsz, itt is frissítjük (később finomítható)
                ta.value = row.content || '';
              }
            })
        .subscribe((statusObj) => {
          status.textContent = 'Realtime: ' + (statusObj?.status || 'unknown');
        });
    }

    async function upsert(text){
      try{ await supabase.from(TABLE).upsert({ id: ID, content: text }, { onConflict: 'id' }); }
      catch(e){ console.error('Upsert hiba', e); }
    }

    function debounce(fn, wait=600){
      let t;
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    function setEditable(v){
      canEdit = !!v;
      ta.readOnly = !v;
      openPw.disabled = v;
      // modal elrejtése és ARIA állapot
      pwModal.classList.add('hidden');
      pwModal.setAttribute('aria-hidden', 'true');
      pwInput.value = '';
      pwNote.style.display = 'none';
      if (v) {
        ta.focus();
        pwInfo.style.display = 'block';
        setTimeout(()=> pwInfo.style.display = 'none', 1200);
      }
    }

    // modal megnyitás
    openPw.addEventListener('click', ()=> {
      pwModal.classList.remove('hidden');
      pwModal.setAttribute('aria-hidden', 'false');
      pwInput.focus();
    });
    // modal bezárás
    pwCancel.addEventListener('click', ()=> {
      pwModal.classList.add('hidden');
      pwModal.setAttribute('aria-hidden', 'true');
      pwInput.value='';
      pwNote.style.display='none';
    });

    // katt a háttérre bezárja a modalt (mobil UX)
    pwModal.addEventListener('click', (e)=>{
      if (e.target === pwModal) {
        pwCancel.click();
      }
    });

    // ok gomb
    pwOk.addEventListener('click', async ()=>{
      const attemptRaw = pwInput.value || '';
      const attempt = attemptRaw.trim(); // trimoljuk: eltünteti a véletlen szóközöket
      try {
        const h = await sha256hex(attempt);
        // debug konzolba (eltávolíthatod később)
        console.log('Attempt:', JSON.stringify(attempt));
        console.log('Hash:', h, 'Expect:', PASSWORD_HASH.toLowerCase());
        if (h === PASSWORD_HASH.toLowerCase()) {
          setEditable(true);
        } else {
          pwNote.style.display = 'block';
          // mobilon is popup, hogy ne maradj bizonytalan
          try { alert('Helytelen jelszó'); } catch(e){}
        }
      } catch (err) {
        console.error('SHA error', err);
        pwNote.style.display = 'block';
      }
    });

    pwInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); pwOk.click(); } });

    const send = debounce(()=> { if (!canEdit) return; upsert(ta.value); }, 600);
    ta.addEventListener('input', ()=> send());

    clearBtn.addEventListener('click', ()=>{
      if (!canEdit){ alert('Előbb engedélyezd az írást jelszóval.'); return; }
      if (!confirm('Biztosan törlöd a tartalmat?')) return;
      ta.value = '';
      upsert('');
    });

    // init
    (async ()=>{ await load(); subscribeRealtime(); })();
  </script>
</body>
</html>