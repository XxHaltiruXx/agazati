<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infosharer ‚Äî jelsz√≥val v√©dett (ment√©s + realtime)</title>
  <style>
    :root{--bg:#0f1720;--card:#0b1220;--muted:#9aa4b2;--accent:#16a34a}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#e6eef6}
    .wrap{max-width:980px;margin:18px auto;padding:18px}
    h1{margin:0 0 8px;font-size:1.25rem}
    .meta{color:var(--muted);margin-bottom:12px}
    textarea{width:100%;min-height:320px;padding:12px;font-size:15px;border-radius:8px;border:1px solid #23303a;background:#08121a;color:#e6eef6;box-sizing:border-box;resize:vertical}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px}
    button{background:linear-gradient(180deg,#0ea35a,#0b8c49);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:transparent;border:1px solid #2b3942;color:#cfe7d3}
    button.ghost{background:transparent;border:1px dashed #2b3942;color:var(--muted)}
    .status{margin-left:auto;color:var(--muted);font-size:0.95rem}
    /* modal */
    #pwModal{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:flex;align-items:center;justify-content:center}
    #pwBox{background:#071424;padding:18px;border-radius:10px;max-width:420px;width:92%;box-shadow:0 6px 30px rgba(2,6,23,0.7)}
    input[type="password"]{width:100%;padding:10px;border-radius:6px;border:1px solid #20323d;background:#081a21;color:#e6eef6;box-sizing:border-box}
    .error{color:#ff7b7b;margin-top:8px;display:none}
    .info{color:#8ee08e;margin-top:8px;display:none}
    small.hint{color:var(--muted);display:block;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Infosharer ‚Äî jelsz√≥val v√©dett</h1>
    <div class="meta">Az oldal alapb√≥l csak olvashat√≥. Kattints az <strong>√çr√°s enged√©lyez√©se</strong>-re, add meg a jelsz√≥t, majd szerkeszd √©s mentsd.</div>

    <textarea id="shared" readonly placeholder="Bet√∂lt√©s..."></textarea>

    <div class="controls">
      <button id="openPw" class="secondary">√çr√°s enged√©lyez√©se (jelsz√≥)</button>
      <button id="saveBtn" class="ghost" disabled>üíæ Ment√©s</button>
      <button id="clearBtn" class="ghost">T√∂rl√©s</button>
      <div class="status" id="status">Kapcsolat: -</div>
    </div>
  </div>

  <!-- Modal (rejtve alapb√≥l, csak gombra ny√≠lik) -->
  <div id="pwModal" style="display:none" aria-hidden="true" role="dialog">
    <div id="pwBox" role="document">
      <h2 style="margin:0 0 8px">√çr√°s jelsz√≥val</h2>
      <div style="font-size:0.95rem;color:var(--muted);margin-bottom:10px">√çrd be a jelsz√≥t, hogy szerkeszthess.</div>
      <input id="pwInput" type="password" autocomplete="off" placeholder="Jelsz√≥" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="pwCancel" class="ghost">M√©gse</button>
        <button id="pwOk">Megnyit√°s</button>
      </div>
      <div class="error" id="pwNote">Helytelen jelsz√≥</div>
      <div class="info" id="pwInfo">Sikeres ‚Äî √≠r√°s enged√©lyezve</div>
      <small class="hint">Sz√≥k√∂z a beviteln√©l: a jelsz√≥ trim-elve lesz (v√©letlen sz√≥k√∂z√∂k elt√°vol√≠t√°sa).</small>
    </div>
  </div>

  <!-- ---------- SCRIPT (modul) ---------- -->
  <script type="module">
    // --------- CONFIG: cser√©ld ki a saj√°t adataidra ----------
    const SUPABASE_URL = 'https://ccpuoqrbmldunshaxpes.supabase.co'; // ‚Üê cser√©ld
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjcHVvcXJibWxkdW5zaGF4cGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTE2MDUsImV4cCI6MjA3ODA4NzYwNX0.QpVCmzF96Fp5hdgFyR0VkT9RV6qKiLkA8Yv_LArSk5I';    // ‚Üê cser√©ld
    const PASSWORD_HASH = '248e464b6e49676c615430dbfb831787d3d7c78e52bd2cb2461608991f7204f6';    // ‚Üê cser√©ld (kisbet≈±s hex)
    const TABLE = 'infosharer';
    const ID = 1;
    // ---------------------------------------------------------

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM elemek
    const ta = document.getElementById('shared');
    const openPw = document.getElementById('openPw');
    const pwModal = document.getElementById('pwModal');
    const pwInput = document.getElementById('pwInput');
    const pwOk = document.getElementById('pwOk');
    const pwCancel = document.getElementById('pwCancel');
    const pwNote = document.getElementById('pwNote');
    const pwInfo = document.getElementById('pwInfo');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');

    let canEdit = false;
    let channelRef = null;

    // Helper: SHA256 hex via Web Crypto
    async function sha256hex(str){
      const enc = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // Load current content (one-time)
    async function load(){
      try {
        const { data, error } = await supabase.from(TABLE).select('content').eq('id', ID).limit(1).single();
        if (!error && data) ta.value = data.content || '';
      } catch(err) { console.error('Load error', err); }
    }

    // Upsert (save)
    async function upsert(text){
      try {
        await supabase.from(TABLE).upsert({ id: ID, content: text }, { onConflict: 'id' });
      } catch(err){ console.error('Upsert error', err); alert('Ment√©s hiba (n√©zd a konzolt)'); }
    }

    // Debounce
    function debounce(fn, wait=600){
      let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
    }

    // Real-time subscribe, with robust status handling
    function subscribeRealtime(){
      try {
        const channelName = 'public:' + TABLE;
        channelRef = supabase
          .channel(channelName)
          .on('postgres_changes', { event: '*', schema: 'public', table: TABLE, filter: `id=eq.${ID}` },
            payload => {
              const row = payload?.new;
              if (row) {
                // Ha a felhaszn√°l√≥ √©ppen g√©pel, mindenk√©pp fel√ºl√≠rjuk a tartalmat is (egyszer≈± LWW)
                ta.value = row.content || '';
              }
            });

        // subscribe returns a Promise-like; .subscribe(cb) may yield different shapes depending on SDK version
        const sub = channelRef.subscribe((statusOrObj) => {
          // SDK k√ºl√∂nb√∂z≈ë verzi√≥k: lehet string vagy objektum { status: 'SUBSCRIBED' } vagy m√°s
          let state = 'kapcsol√≥d√°s...';
          try {
            if (!statusOrObj) state = 'kapcsol√≥d√°s...';
            else if (typeof statusOrObj === 'string') {
              state = (statusOrObj === 'SUBSCRIBED') ? '√©l≈ë' : (statusOrObj === 'CLOSED' ? 'megszakadt' : statusOrObj);
            } else if (typeof statusOrObj === 'object') {
              const s = statusOrObj.status || statusOrObj;
              state = (s === 'SUBSCRIBED') ? '√©l≈ë' : (s === 'CLOSED' ? 'megszakadt' : s);
            } else {
              state = String(statusOrObj);
            }
          } catch(e){ state = 'ismeretlen'; }
          statusEl.textContent = 'Kapcsolat: ' + state;
        });

        // fallback: ha a subscribe Promise reject√°l√≥dik
        sub.on('error', (err) => {
          console.warn('Channel error', err);
          statusEl.textContent = 'Kapcsolat: hiba';
        });
      } catch(err){
        console.error('subscribeRealtime error', err);
        statusEl.textContent = 'Kapcsolat: hiba';
      }
    }

    // UI: a nem-modul r√©sz (modal) r√°von√°sa
    document.addEventListener('DOMContentLoaded', () => {
      // modal alap√°llapot: rejtve
      pwModal.style.display = 'none';
      pwModal.setAttribute('aria-hidden', 'true');
      ta.readOnly = true;
      saveBtn.disabled = true;

      // open modal
      openPw.addEventListener('click', () => {
        pwNote.style.display = 'none';
        pwInfo.style.display = 'none';
        pwModal.style.display = 'flex';
        pwModal.setAttribute('aria-hidden', 'false');
        pwInput.value = '';
        setTimeout(()=> pwInput.focus(), 50);
      });

      // cancel modal
      pwCancel.addEventListener('click', () => {
        pwModal.style.display = 'none';
        pwModal.setAttribute('aria-hidden', 'true');
        pwInput.value = '';
        pwNote.style.display = 'none';
      });

      // click outside closes
      pwModal.addEventListener('click', (e) => {
        if (e.target === pwModal) pwCancel.click();
      });

      // on Enter
      pwInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); pwOk.click(); } });

      // pwOk -> compute hash & dispatch custom event
      pwOk.addEventListener('click', async () => {
        const raw = pwInput.value || '';
        const attempt = raw.trim();
        pwNote.style.display = 'none';
        try {
          const h = await sha256hex(attempt);
          // dispatch event with hash and raw (trimmed)
          document.dispatchEvent(new CustomEvent('infosharer:pwAttempt', { detail: { hash: h, raw: attempt } }));
        } catch(err){
          console.error('sha error', err);
          pwNote.textContent = 'Hiba a jelsz√≥ellen≈ërz√©sn√©l';
          pwNote.style.display = 'block';
        }
      });

      // save button manual
      saveBtn.addEventListener('click', async () => {
        if (!canEdit) { alert('El≈ëbb enged√©lyezd az √≠r√°st jelsz√≥val.'); return; }
        saveBtn.textContent = 'Ment√©s...';
        saveBtn.disabled = true;
        await upsert(ta.value);
        saveBtn.textContent = '‚úÖ Mentve';
        setTimeout(()=> { saveBtn.textContent = 'üíæ Ment√©s'; saveBtn.disabled = false; }, 900);
      });

      // clear button
      clearBtn.addEventListener('click', async () => {
        if (!canEdit) { alert('El≈ëbb enged√©lyezd az √≠r√°st jelsz√≥val.'); return; }
        if (!confirm('Biztosan t√∂rl√∂d a tartalmat?')) return;
        ta.value = '';
        await upsert('');
      });

      // auto save debounce (still available)
      const send = debounce(()=> { if (!canEdit) return; upsert(ta.value); }, 800);
      ta.addEventListener('input', () => send());
    });

    // Handle pwAttempt (compare with local PASSWORD_HASH)
    document.addEventListener('infosharer:pwAttempt', (ev) => {
      try {
        const sentHash = (ev?.detail?.hash || '').toLowerCase();
        if (!PASSWORD_HASH || PASSWORD_HASH.length === 0 || PASSWORD_HASH === 'replace_with_sha256_hex_of_password') {
          // safety: if dev forgot to replace, refuse and inform
          document.dispatchEvent(new CustomEvent('infosharer:authFail', { detail: { message: 'A szerver nincs konfigur√°lva (PASSWORD_HASH hi√°nyzik).' } }));
          return;
        }
        if (sentHash === PASSWORD_HASH.toLowerCase()) {
          // success: inform UI
          document.dispatchEvent(new CustomEvent('infosharer:authSuccess'));
          canEdit = true;
          // enable save button
          saveBtn.disabled = false;
          // optionally focus textarea
          setTimeout(()=> ta.focus(), 50);
        } else {
          document.dispatchEvent(new CustomEvent('infosharer:authFail', { detail: { message: 'Helytelen jelsz√≥' } }));
        }
      } catch(err){
        console.error('pwAttempt handler err', err);
        document.dispatchEvent(new CustomEvent('infosharer:authFail', { detail: { message: 'Hiba' } }));
      }
    });

    // UI listeners for auth result
    document.addEventListener('infosharer:authSuccess', () => {
      pwModal.style.display = 'none';
      pwModal.setAttribute('aria-hidden', 'true');
      pwInput.value = '';
      pwNote.style.display = 'none';
      pwInfo.style.display = 'block';
      setTimeout(()=> pwInfo.style.display = 'none', 1200);
      ta.readOnly = false;
      openPw.disabled = true;
    });

    document.addEventListener('infosharer:authFail', (e) => {
      pwNote.textContent = e?.detail?.message || 'Helytelen jelsz√≥';
      pwNote.style.display = 'block';
    });

    // init: load + subscribe
    (async function init(){
      await load();
      subscribeRealtime();
    })();

  </script>
</body>
</html>